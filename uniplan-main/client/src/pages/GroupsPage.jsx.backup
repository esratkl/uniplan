import React, { useState, useEffect, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import {
    Send, Search, Users, UserPlus, X, Check, Plus,
    MessageCircle, LogIn, MoreVertical, Phone, Video,
    Smile, Paperclip, ArrowLeft, Settings, Moon, Sun, Palette,
    Crown, UserMinus, Bell, BellOff, Shield, Sparkles, Star, Hash,
    Image, Mic, AtSign, Link2, PhoneOff, Ban, Trash2, LogOut
} from 'lucide-react';
import '../styles/Chat.css';
import '../styles/GroupsEnhanced.css';

// Wallpaper options with images
const WALLPAPERS = [
    { id: 'default', name: 'VarsayÄ±lan', type: 'gradient', value: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)' },
    { id: 'mountains', name: 'DaÄŸlar', type: 'image', value: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80' },
    { id: 'ocean', name: 'Okyanus', type: 'image', value: 'https://images.unsplash.com/photo-1518837695005-2083093ee35b?w=1920&q=80' },
    { id: 'forest', name: 'Orman', type: 'image', value: 'https://images.unsplash.com/photo-1448375240586-882707db888b?w=1920&q=80' },
    { id: 'galaxy', name: 'Galaksi', type: 'image', value: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=1920&q=80' },
    { id: 'sunset', name: 'GÃ¼n BatÄ±mÄ±', type: 'image', value: 'https://images.unsplash.com/photo-1495616811223-4d98c6e9c869?w=1920&q=80' },
    { id: 'city', name: 'Åžehir', type: 'image', value: 'https://images.unsplash.com/photo-1519501025264-65ba15a82390?w=1920&q=80' },
    { id: 'aurora', name: 'Kuzey IÅŸÄ±klarÄ±', type: 'image', value: 'https://images.unsplash.com/photo-1531366936337-7c912a4589a7?w=1920&q=80' },
];

// Color themes with gradients
const COLOR_THEMES = [
    { id: 'purple', name: 'Mor', primary: '#8b5cf6', secondary: '#6366f1', gradient: 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #a855f7 100%)' },
    { id: 'blue', name: 'Mavi', primary: '#3b82f6', secondary: '#0ea5e9', gradient: 'linear-gradient(135deg, #3b82f6 0%, #0ea5e9 50%, #06b6d4 100%)' },
    { id: 'green', name: 'YeÅŸil', primary: '#22c55e', secondary: '#10b981', gradient: 'linear-gradient(135deg, #22c55e 0%, #10b981 50%, #14b8a6 100%)' },
    { id: 'pink', name: 'Pembe', primary: '#ec4899', secondary: '#f472b6', gradient: 'linear-gradient(135deg, #ec4899 0%, #f472b6 50%, #f43f5e 100%)' },
    { id: 'orange', name: 'Turuncu', primary: '#f97316', secondary: '#fb923c', gradient: 'linear-gradient(135deg, #f97316 0%, #fb923c 50%, #fbbf24 100%)' },
    { id: 'red', name: 'KÄ±rmÄ±zÄ±', primary: '#ef4444', secondary: '#f87171', gradient: 'linear-gradient(135deg, #ef4444 0%, #f87171 50%, #dc2626 100%)' },
    { id: 'teal', name: 'Turkuaz', primary: '#14b8a6', secondary: '#2dd4bf', gradient: 'linear-gradient(135deg, #14b8a6 0%, #2dd4bf 50%, #0d9488 100%)' },
    { id: 'indigo', name: 'Ä°ndigo', primary: '#6366f1', secondary: '#818cf8', gradient: 'linear-gradient(135deg, #6366f1 0%, #818cf8 50%, #4f46e5 100%)' },
];

// Emoji categories
const EMOJI_CATEGORIES = {
    smileys: { icon: 'ðŸ˜€', emojis: ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ¤£', 'ðŸ˜‚', 'ðŸ™‚', 'ðŸ˜Š', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ¤”', 'ðŸ˜´', 'ðŸ¤¯'] },
    emotions: { icon: 'â¤ï¸', emojis: ['â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ–¤', 'ðŸ¤', 'ðŸ’”', 'â¤ï¸â€ðŸ”¥', 'ðŸ’•', 'ðŸ’–', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ’€', 'ðŸ‘»', 'ðŸ‘½', 'ðŸ¤–', 'ðŸ˜º', 'ðŸ˜»'] },
    gestures: { icon: 'ðŸ‘‹', emojis: ['ðŸ‘‹', 'ðŸ‘Œ', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘', 'ðŸ‘Ž', 'âœŠ', 'ðŸ‘Š', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ¤', 'ðŸ™', 'ðŸ’ª', 'âœï¸', 'ðŸ¤³'] },
    objects: { icon: 'ðŸŽ‰', emojis: ['ðŸŽ‰', 'ðŸŽŠ', 'ðŸŽ', 'ðŸŽˆ', 'ðŸŽ®', 'ðŸŽ§', 'ðŸŽ¼', 'ðŸ“±', 'ðŸ’»', 'ðŸ’°', 'ðŸ’Ž', 'ðŸ”‘', 'ðŸ“·', 'ðŸŽ¥', 'â°', 'ðŸ’¡', 'ðŸ“š', 'âœï¸'] },
    nature: { icon: 'ðŸŒ¸', emojis: ['ðŸ¶', 'ðŸ±', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ¦', 'ðŸ¸', 'ðŸŒ¸', 'ðŸŒ¹', 'ðŸŒ»', 'ðŸ€', 'ðŸŒ´', 'â˜€ï¸', 'ðŸŒ™', 'â­', 'ðŸŒˆ', 'ðŸ”¥', 'ðŸ’§', 'ðŸŒŠ'] },
    food: { icon: 'ðŸ•', emojis: ['ðŸŽ', 'ðŸ•', 'ðŸ”', 'ðŸŸ', 'ðŸŒ­', 'ðŸ¿', 'ðŸ¦', 'ðŸŽ‚', 'ðŸ©', 'â˜•', 'ðŸº', 'ðŸ¥¤', 'ðŸ·'] },
    symbols: { icon: 'ðŸ’¯', emojis: ['ðŸ’¯', 'âœ…', 'âŒ', 'â“', 'â—', 'ðŸ’¢', 'ðŸ’¥', 'ðŸ’«', 'ðŸ’¬', 'ðŸ’­', 'ðŸ”´', 'ðŸŸ¢', 'ðŸ”µ', 'ðŸŸ£', 'â­', 'âœ¨'] },
};

// Stickers with categories
const STICKERS = [
    { id: 's1', name: 'Mutlu', url: 'https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif', category: 'happy' },
    { id: 's2', name: 'Thumbs Up', url: 'https://media.giphy.com/media/111ebonMs90YLu/giphy.gif', category: 'gesture' },
    { id: 's3', name: 'Kalp', url: 'https://media.giphy.com/media/26BRv0ThflsHCqDrG/giphy.gif', category: 'love' },
    { id: 's4', name: 'Kutlama', url: 'https://media.giphy.com/media/g9582DNuQppxC/giphy.gif', category: 'happy' },
    { id: 's5', name: 'LOL', url: 'https://media.giphy.com/media/10JhviFuU2gWD6/giphy.gif', category: 'funny' },
    { id: 's6', name: 'Dans', url: 'https://media.giphy.com/media/l0MYGb1LuZ3n7dRnO/giphy.gif', category: 'fun' },
    { id: 's7', name: 'Cool', url: 'https://media.giphy.com/media/62PP2yEIAZF6g/giphy.gif', category: 'cool' },
    { id: 's8', name: 'Wow', url: 'https://media.giphy.com/media/udmx3pgdiD7tm/giphy.gif', category: 'reaction' },
    { id: 's9', name: 'Evet!', url: 'https://media.giphy.com/media/l2JJKs3I69qfaQleE/giphy.gif', category: 'gesture' },
    { id: 's10', name: 'HayÄ±r', url: 'https://media.giphy.com/media/3o7TKwmnDgQb5jemjK/giphy.gif', category: 'gesture' },
    { id: 's11', name: 'TeÅŸekkÃ¼r', url: 'https://media.giphy.com/media/osjgQPWRx3cac/giphy.gif', category: 'happy' },
    { id: 's12', name: 'Parti', url: 'https://media.giphy.com/media/l0MYJnJQ4EiYLxvQ4/giphy.gif', category: 'fun' },
    { id: 's13', name: 'Hi', url: 'https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/giphy.gif', category: 'greeting' },
    { id: 's14', name: 'AÅŸk', url: 'https://media.giphy.com/media/l4pTdcifPZLpDjL1e/giphy.gif', category: 'love' },
    { id: 's15', name: 'HeyecanlÄ±', url: 'https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif', category: 'reaction' },
    { id: 's16', name: 'ÃœzgÃ¼n', url: 'https://media.giphy.com/media/OPU6wzx8JrHna/giphy.gif', category: 'sad' },
];



// Mock database of all users to search from
const PREDEFINED_USERS = [
    { id: 'u1', name: 'Sibel Kaya', avatar: 'SK', status: 'MÃ¼sait', role: 'member' },
    { id: 'u2', name: 'Ahmet YÄ±lmaz', avatar: 'AY', status: 'MeÅŸgul', role: 'member' },
    { id: 'u3', name: 'Sibel Demir', avatar: 'SD', status: 'ToplantÄ±da', role: 'member' },
    { id: 'u4', name: 'Canan YÄ±ldÄ±z', avatar: 'CY', status: 'MÃ¼sait', role: 'member' },
    { id: 'u5', name: 'BarÄ±ÅŸ Ã–zkan', avatar: 'BÃ–', status: 'DÄ±ÅŸarÄ±da', role: 'member' },
    { id: 'u6', name: 'Sibel Ã–ztÃ¼rk', avatar: 'SÃ–', status: 'Ã‡evrimiÃ§i', role: 'member' },
    { id: 'u7', name: 'Murat Ã‡elik', avatar: 'MÃ‡', status: 'Kod yazÄ±yor', role: 'member' },
];

const GroupsPage = () => {
    const { user } = useAuth();

    // Theme & Customization
    const [isDarkMode, setIsDarkMode] = useState(true);
    const [selectedWallpaper, setSelectedWallpaper] = useState('galaxy');
    const [selectedColorTheme, setSelectedColorTheme] = useState('pink');
    const [showSettings, setShowSettings] = useState(false);

    // Options Menu
    const [showOptionsMenu, setShowOptionsMenu] = useState(false);
    const [mutedGroups, setMutedGroups] = useState([]);

    // Groups & Selection
    const [groups, setGroups] = useState([
        {
            id: 'g1',
            name: 'Proje Ekibi',
            description: 'Ana proje geliÅŸtirme grubu',
            avatar: 'PE',
            memberCount: 5,
            onlineCount: 3,
            lastMessage: 'ToplantÄ± yarÄ±n saat 10:00',
            lastMessageTime: new Date(),
            lastMessageSender: 'Ali',
            unread: 3,
            isAdmin: true,
            isPinned: true,
            color: '#ec4899'
        },
        {
            id: 'g2',
            name: 'YazÄ±lÄ±m TakÄ±mÄ±',
            description: 'Backend & Frontend geliÅŸtiriciler',
            avatar: 'YT',
            memberCount: 8,
            onlineCount: 5,
            lastMessage: 'Deploy tamamlandÄ±! ðŸŽ‰',
            lastMessageTime: new Date(Date.now() - 3600000),
            lastMessageSender: 'Mehmet',
            unread: 0,
            isAdmin: true,
            isPinned: true,
            color: '#3b82f6'
        },
        {
            id: 'g3',
            name: 'TasarÄ±m Grubu',
            description: 'UI/UX tasarÄ±m ekibi',
            avatar: 'TG',
            memberCount: 4,
            onlineCount: 2,
            lastMessage: 'Yeni mockuplar hazÄ±r ðŸŽ¨',
            lastMessageTime: new Date(Date.now() - 7200000),
            lastMessageSender: 'Zeynep',
            unread: 5,
            isAdmin: true,
            isPinned: false,
            color: '#8b5cf6'
        },
        {
            id: 'g4',
            name: 'Pazarlama',
            description: 'Marketing ve sosyal medya',
            avatar: 'PZ',
            memberCount: 6,
            onlineCount: 1,
            lastMessage: 'Kampanya baÅŸladÄ±',
            lastMessageTime: new Date(Date.now() - 86400000),
            lastMessageSender: 'AyÅŸe',
            unread: 0,
            isAdmin: true,
            isPinned: false,
            color: '#f97316'
        },
    ]);
    const [selectedGroup, setSelectedGroup] = useState(null);
    const [searchQuery, setSearchQuery] = useState('');
    const [filter, setFilter] = useState('all');
    const [isTyping, setIsTyping] = useState(false);
    const [typingUsers, setTypingUsers] = useState([]);

    // Call States
    const [showCallModal, setShowCallModal] = useState(false);
    const [callType, setCallType] = useState('voice'); // 'voice' or 'video'
    const [callStatus, setCallStatus] = useState('calling'); // 'calling', 'connected', 'ended'
    const [callDuration, setCallDuration] = useState(0);
    const localVideoRef = useRef(null);

    // Call Effect for Camera
    useEffect(() => {
        let stream = null;

        const startCamera = async () => {
            if (showCallModal && callType === 'video') {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    if (localVideoRef.current) {
                        localVideoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error("Kamera hatasÄ±:", err);
                    alert("Kamera eriÅŸimi saÄŸlanamadÄ±. LÃ¼tfen izinleri kontrol edin.");
                }
            }
        };

        startCamera();

        return () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        };
    }, [showCallModal, callType]);

    // Start a call
    const startCall = (type) => {
        if (!selectedGroup) return;
        setCallType(type);
        setCallStatus('calling');
        setCallDuration(0);
        setShowCallModal(true);

        // Simulate call connection after 2 seconds
        setTimeout(() => {
            setCallStatus('connected');
            // Start duration timer
            const timer = setInterval(() => {
                setCallDuration(prev => prev + 1);
            }, 1000);
            // Store timer to clear later
            window.callTimer = timer;
        }, 2000);
    };

    // End call
    const endCall = () => {
        if (window.callTimer) {
            clearInterval(window.callTimer);
        }

        // Create call log message
        if (selectedGroup) {
            const callLogMessage = {
                id: Date.now(),
                content: `${callType === 'video' ? 'GÃ¶rÃ¼ntÃ¼lÃ¼ Grup AramasÄ±' : 'Sesli Grup AramasÄ±'} - ${formatDuration(callDuration)}`,
                type: 'call-log',
                callType: callType,
                duration: formatDuration(callDuration),
                senderId: 'system',
                senderName: 'Sistem',
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                isMe: false,
                isSystem: true
            };

            setMessages(prev => ({
                ...prev,
                [selectedGroup.id]: [...(prev[selectedGroup.id] || []), callLogMessage]
            }));

            // Update last message in groups list
            setGroups(prev => prev.map(g =>
                g.id === selectedGroup.id
                    ? { ...g, lastMessage: `${callType === 'video' ? 'ðŸ“¹' : 'ðŸ“ž'} Grup AramasÄ±`, lastMessageTime: new Date() }
                    : g
            ));
        }

        setCallStatus('ended');
        setTimeout(() => {
            setShowCallModal(false);
            setCallStatus('calling');
            setCallDuration(0);
        }, 1000);
    };

    // Format call duration
    const formatDuration = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    };

    // Messages
    const [messages, setMessages] = useState({});
    const [inputMessage, setInputMessage] = useState('');
    const messagesEndRef = useRef(null);

    // Emoji & Stickers
    const [showEmojiPicker, setShowEmojiPicker] = useState(false);
    const [emojiTab, setEmojiTab] = useState('emoji');
    const [emojiCategory, setEmojiCategory] = useState('smileys');
    const [favoriteEmojis, setFavoriteEmojis] = useState(['ðŸ˜€', 'â¤ï¸', 'ðŸ‘', 'ðŸŽ‰', 'ðŸ”¥', 'ðŸ˜‚', 'âœ…', 'ðŸ’¯', 'ðŸ™', 'âœ¨']);
    const fileInputRef = useRef(null);

    // Modals
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showJoinModal, setShowJoinModal] = useState(false);
    const [showMembersModal, setShowMembersModal] = useState(false);
    const [showGroupInfo, setShowGroupInfo] = useState(false);
    const [newGroupName, setNewGroupName] = useState('');
    const [newGroupDescription, setNewGroupDescription] = useState('');
    const [newGroupPassword, setNewGroupPassword] = useState('');
    const [joinGroupName, setJoinGroupName] = useState('');
    const [joinGroupPassword, setJoinGroupPassword] = useState('');

    // Mock members with more details
    // Mock members with more details - CONVERTED TO STATE
    // Mock members with more details - PER GROUP STATE
    const [groupMembers, setGroupMembers] = useState({
        'g1': [
            { id: 'm1', name: 'Ali YÄ±lmaz', avatar: 'AY', role: 'admin', online: true, lastSeen: 'Åžimdi aktif', status: 'Kodlama yapÄ±yor ðŸ’»' },
            { id: 'm2', name: 'Zeynep Demir', avatar: 'ZD', role: 'moderator', online: true, lastSeen: 'Åžimdi aktif', status: 'TasarÄ±m modunda ðŸŽ¨' },
            { id: 'm3', name: 'Mehmet Kaya', avatar: 'MK', role: 'member', online: false, lastSeen: '2 saat Ã¶nce', status: '' },
            { id: 'm4', name: 'AyÅŸe Ã‡elik', avatar: 'AÃ‡', role: 'member', online: true, lastSeen: 'Åžimdi aktif', status: 'ToplantÄ±da ðŸ“ž' },
            { id: 'm5', name: 'Can YÄ±ldÄ±z', avatar: 'CY', role: 'member', online: false, lastSeen: 'DÃ¼n', status: '' },
        ],
        'g2': [
            { id: 'm3', name: 'Mehmet Kaya', avatar: 'MK', role: 'admin', online: true, lastSeen: 'Åžimdi aktif', status: '' },
            { id: 'm6', name: 'Burak YÄ±lmaz', avatar: 'BY', role: 'member', online: false, lastSeen: '1 gÃ¼n Ã¶nce', status: 'Tatilde ðŸŒ´' },
            { id: 'm7', name: 'Selin Åžahin', avatar: 'SÅž', role: 'member', online: true, lastSeen: 'Åžimdi aktif', status: 'YazÄ±yor...' },
        ],
        'g3': [
            { id: 'm8', name: 'Deniz Arslan', avatar: 'DA', role: 'admin', online: true, lastSeen: 'Åžimdi aktif', status: 'Oyun oynuyor ðŸŽ®' },
            { id: 'm9', name: 'Eren Kara', avatar: 'EK', role: 'moderator', online: false, lastSeen: '5 dakika Ã¶nce', status: '' },
        ],
        'g4': [
            { id: 'm10', name: 'AyÅŸe YÄ±lmaz', avatar: 'AY', role: 'admin', online: true, lastSeen: 'Åžimdi aktif', status: 'ToplantÄ±da ðŸ“Š' },
            { id: 'm11', name: 'Kemal Sunal', avatar: 'KS', role: 'member', online: false, lastSeen: '2 gÃ¼n Ã¶nce', status: '' },
            { id: 'm12', name: 'Fatma Girik', avatar: 'FG', role: 'member', online: true, lastSeen: 'Åžimdi aktif', status: 'YazÄ±yor...' },
        ]
    });
    const [memberSearchQuery, setMemberSearchQuery] = useState('');
    const [activeMemberMenu, setActiveMemberMenu] = useState(null); // ID of member whose menu is open

    // Derived state for filtered members
    const currentGroupMembers = selectedGroup ? (groupMembers[selectedGroup.id] || []) : [];
    const filteredMembers = currentGroupMembers.filter(member =>
        member.name.toLowerCase().includes(memberSearchQuery.toLowerCase())
    );

    // Role Management


    const [showAddMemberModal, setShowAddMemberModal] = useState(false);
    const [newMemberName, setNewMemberName] = useState('');
    const [searchResults, setSearchResults] = useState([]);

    const handleAddSpecificMember = (userToAdd) => {
        if (!selectedGroup) return;

        const newMember = {
            id: `m${Date.now()}`, // Generate a new member ID for the group context
            name: userToAdd.name,
            avatar: userToAdd.avatar,
            role: 'member',
            online: false,
            lastSeen: 'HenÃ¼z eklendi',
            status: userToAdd.status
        };

        setGroupMembers(prev => ({
            ...prev,
            [selectedGroup.id]: [...(prev[selectedGroup.id] || []), newMember]
        }));

        // Update member count
        setGroups(prev => prev.map(g =>
            g.id === selectedGroup.id
                ? { ...g, memberCount: g.memberCount + 1 }
                : g
        ));
    };

    const handleAddMember = () => {
        if (!selectedGroup) return;
        setShowAddMemberModal(true);
    };

    const submitAddMember = () => {
        if (!selectedGroup || !newMemberName.trim()) return;

        const name = newMemberName.trim();
        const newMember = {
            id: `m${Date.now()}`,
            name: name,
            avatar: name.substring(0, 2).toUpperCase(),
            role: 'member',
            online: false,
            lastSeen: 'HenÃ¼z yeni eklendi',
            status: 'Yeni Ãœye âœ¨'
        };

        setGroupMembers(prev => ({
            ...prev,
            [selectedGroup.id]: [...(prev[selectedGroup.id] || []), newMember]
        }));

        // Update member count
        setGroups(prev => prev.map(g =>
            g.id === selectedGroup.id
                ? { ...g, memberCount: g.memberCount + 1 }
                : g
        ));

        setShowAddMemberModal(false);
        setNewMemberName('');
    };

    // Current theme
    const currentTheme = COLOR_THEMES.find(t => t.id === selectedColorTheme) || COLOR_THEMES[0];
    const currentWallpaper = WALLPAPERS.find(w => w.id === selectedWallpaper) || WALLPAPERS[0];

    // Initialize mock messages with more variety
    useEffect(() => {
        const mockMessages = {
            'g1': [
                { id: 1, content: 'Herkese merhaba! ðŸ‘‹', senderId: 'm1', senderName: 'Ali YÄ±lmaz', senderAvatar: 'AY', time: '10:00', isMe: false },
                { id: 2, content: 'Proje ne durumda arkadaÅŸlar?', senderId: 'm2', senderName: 'Zeynep Demir', senderAvatar: 'ZD', time: '10:05', isMe: false },
                { id: 3, content: 'Backend bitti, frontend devam ediyor ðŸš€', senderId: 'me', time: '10:10', isMe: true },
                { id: 4, content: 'Harika! Ben de tasarÄ±mlarÄ± tamamladÄ±m', senderId: 'm2', senderName: 'Zeynep Demir', senderAvatar: 'ZD', time: '10:12', isMe: false },
                { id: 5, content: 'ToplantÄ± yarÄ±n saat 10:00\'da yapalÄ±m mÄ±?', senderId: 'm1', senderName: 'Ali YÄ±lmaz', senderAvatar: 'AY', time: '10:15', isMe: false },
                { id: 6, content: 'Bence de uygun ðŸ‘', senderId: 'm4', senderName: 'AyÅŸe Ã‡elik', senderAvatar: 'AÃ‡', time: '10:18', isMe: false },
            ],
            'g2': [
                { id: 1, content: 'Deploy baÅŸlÄ±yor! ðŸŽ¬', senderId: 'm3', senderName: 'Mehmet Kaya', senderAvatar: 'MK', time: '14:00', isMe: false },
                { id: 2, content: 'Build baÅŸarÄ±lÄ± âœ…', senderId: 'm3', senderName: 'Mehmet Kaya', senderAvatar: 'MK', time: '14:15', isMe: false },
                { id: 3, content: 'Deploy tamamlandÄ±! ðŸŽ‰', senderId: 'm3', senderName: 'Mehmet Kaya', senderAvatar: 'MK', time: '14:30', isMe: false },
            ],
        };
        setMessages(mockMessages);

        // Simulate typing
        setTimeout(() => {
            setTypingUsers(['Zeynep']);
        }, 3000);
        setTimeout(() => {
            setTypingUsers([]);
        }, 6000);
    }, []);

    // Load/Save preferences
    useEffect(() => {
        const savedTheme = localStorage.getItem('groupColorTheme');
        const savedWallpaper = localStorage.getItem('groupWallpaper');
        const savedDarkMode = localStorage.getItem('groupDarkMode');
        if (savedTheme) setSelectedColorTheme(savedTheme);
        if (savedWallpaper) setSelectedWallpaper(savedWallpaper);
        if (savedDarkMode !== null) setIsDarkMode(savedDarkMode === 'true');
    }, []);

    useEffect(() => {
        localStorage.setItem('groupColorTheme', selectedColorTheme);
        localStorage.setItem('groupWallpaper', selectedWallpaper);
        localStorage.setItem('groupDarkMode', isDarkMode.toString());
    }, [selectedColorTheme, selectedWallpaper, isDarkMode]);

    // Scroll to bottom
    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages, selectedGroup]);

    // Filter groups
    const filteredGroups = groups.filter(g => {
        const matchesSearch = g.name.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesFilter = filter === 'all' || (filter === 'admin' && g.isAdmin) || (filter === 'pinned' && g.isPinned);
        return matchesSearch && matchesFilter;
    }).sort((a, b) => {
        if (a.isPinned && !b.isPinned) return -1;
        if (!a.isPinned && b.isPinned) return 1;
        return new Date(b.lastMessageTime) - new Date(a.lastMessageTime);
    });

    // Send message
    const handleSendMessage = (e) => {
        e.preventDefault();
        if (!inputMessage.trim() || !selectedGroup) return;

        const newMessage = {
            id: Date.now(),
            content: inputMessage.trim(),
            senderId: 'me',
            time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
            isMe: true
        };

        setMessages(prev => ({
            ...prev,
            [selectedGroup.id]: [...(prev[selectedGroup.id] || []), newMessage]
        }));

        setGroups(prev => prev.map(g =>
            g.id === selectedGroup.id
                ? { ...g, lastMessage: inputMessage.trim(), lastMessageTime: new Date(), lastMessageSender: 'Sen', unread: 0 }
                : g
        ));

        setInputMessage('');
        setShowEmojiPicker(false);
    };

    // Add emoji
    const addEmoji = (emoji) => {
        setInputMessage(prev => prev + emoji);
    };

    // Send sticker
    const sendSticker = (sticker) => {
        if (!selectedGroup) return;
        const newMessage = {
            id: Date.now(),
            content: '',
            sticker: sticker.url,
            stickerName: sticker.name,
            senderId: 'me',
            time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
            isMe: true
        };
        setMessages(prev => ({
            ...prev,
            [selectedGroup.id]: [...(prev[selectedGroup.id] || []), newMessage]
        }));
        setGroups(prev => prev.map(g =>
            g.id === selectedGroup.id
                ? { ...g, lastMessage: `ðŸŽ­ ${sticker.name}`, lastMessageTime: new Date(), lastMessageSender: 'Sen' }
                : g
        ));
        setShowEmojiPicker(false);
    };

    // Handle file upload
    const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file || !selectedGroup) return;
        const isImage = file.type.startsWith('image/');
        const reader = new FileReader();
        reader.onload = (event) => {
            const newMessage = {
                id: Date.now(),
                content: isImage ? '' : `ðŸ“Ž ${file.name}`,
                image: isImage ? event.target.result : null,
                senderId: 'me',
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                isMe: true
            };
            setMessages(prev => ({
                ...prev,
                [selectedGroup.id]: [...(prev[selectedGroup.id] || []), newMessage]
            }));
            setGroups(prev => prev.map(g =>
                g.id === selectedGroup.id
                    ? { ...g, lastMessage: isImage ? 'ðŸ“· FotoÄŸraf' : `ðŸ“Ž ${file.name}`, lastMessageTime: new Date(), lastMessageSender: 'Sen' }
                    : g
            ));
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    };

    // Create group
    const handleCreateGroup = () => {
        if (!newGroupName.trim()) return;
        const colors = ['#ec4899', '#3b82f6', '#8b5cf6', '#22c55e', '#f97316', '#ef4444'];
        const newGroupId = `g${Date.now()}`;
        const newGroup = {
            id: newGroupId,
            name: newGroupName.trim(),
            description: newGroupDescription.trim() || 'Yeni grup',
            avatar: newGroupName.substring(0, 2).toUpperCase(),
            memberCount: 1,
            onlineCount: 1,
            lastMessage: 'Grup oluÅŸturuldu âœ¨',
            lastMessageTime: new Date(),
            lastMessageSender: 'Sistem',
            unread: 0,
            isAdmin: true,
            isPinned: false,
            color: colors[Math.floor(Math.random() * colors.length)]
        };

        // Add current user as admin
        setGroupMembers(prev => ({
            ...prev,
            [newGroupId]: [{
                id: 'me',
                name: user?.name || 'Ben',
                avatar: (user?.name || 'B').substring(0, 2).toUpperCase(),
                role: 'admin',
                online: true,
                lastSeen: 'Åžimdi aktif',
                status: 'Grup Kurucusu ðŸ‘‘'
            }]
        }));

        setGroups(prev => [newGroup, ...prev]);
        setShowCreateModal(false);
        setNewGroupName('');
        setNewGroupDescription('');
        setNewGroupPassword('');
    };

    // Join group
    const handleJoinGroup = () => {
        if (!joinGroupName.trim()) return;
        alert(`"${joinGroupName}" grubuna katÄ±lma isteÄŸi gÃ¶nderildi! âœ¨`);
        setShowJoinModal(false);
        setJoinGroupName('');
        setJoinGroupPassword('');
    };

    // Toggle pin
    const togglePin = (groupId) => {
        setGroups(prev => prev.map(g =>
            g.id === groupId ? { ...g, isPinned: !g.isPinned } : g
        ));
    };

    // Confirmation Modal State
    const [confirmModal, setConfirmModal] = useState({
        isOpen: false,
        type: null, // 'delete' or 'leave'
        title: '',
        message: '',
        data: null
    });

    // Handle Confirm Action
    const handleConfirmAction = () => {
        if (confirmModal.type === 'delete') {
            const groupId = confirmModal.data;
            setMessages(prev => {
                const newMessages = { ...prev };
                delete newMessages[groupId];
                return newMessages;
            });
            setGroups(prev => prev.map(g =>
                g.id === groupId ? { ...g, lastMessage: '', unread: 0 } : g
            ));
            setShowOptionsMenu(false);
        } else if (confirmModal.type === 'leave') {
            const groupId = confirmModal.data;
            setGroups(prev => prev.filter(g => g.id !== groupId));
            setSelectedGroup(null);
            setShowOptionsMenu(false);
        } else if (confirmModal.type === 'remove_member') {
            const memberId = confirmModal.data;
            setGroupMembers(prev => ({
                ...prev,
                [selectedGroup.id]: prev[selectedGroup.id].filter(m => m.id !== memberId)
            }));
            setGroups(prev => prev.map(g =>
                g.id === selectedGroup.id
                    ? { ...g, memberCount: Math.max(0, g.memberCount - 1) }
                    : g
            ));
        }
        setConfirmModal(prev => ({ ...prev, isOpen: false }));
    };

    // Toggle mute group (block notifications)
    const toggleMuteGroup = (groupId) => {
        if (mutedGroups.includes(groupId)) {
            setMutedGroups(prev => prev.filter(id => id !== groupId));
        } else {
            setMutedGroups(prev => [...prev, groupId]);
        }
        setShowOptionsMenu(false);
    };

    // Delete group chat
    const deleteGroupChat = (groupId) => {
        setConfirmModal({
            isOpen: true,
            type: 'delete',
            title: 'Sohbeti Sil',
            message: 'Bu grup sohbetini silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.',
            data: groupId
        });
    };

    // Leave group
    const leaveGroup = (groupId) => {
        setConfirmModal({
            isOpen: true,
            type: 'leave',
            title: 'Gruptan AyrÄ±l',
            message: 'Bu gruptan ayrÄ±lmak istediÄŸinizden emin misiniz?',
            data: groupId
        });
    };

    // Get time ago
    const getTimeAgo = (date) => {
        const now = new Date();
        const diff = now - new Date(date);
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        if (minutes < 1) return 'Åžimdi';
        if (minutes < 60) return `${minutes}d`;
        if (hours < 24) return `${hours}s`;
        if (days < 7) return `${days}g`;
        return new Date(date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
    };

    // Wallpaper style
    const getWallpaperStyle = () => {
        if (currentWallpaper.type === 'image') {
            return {
                backgroundImage: `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url(${currentWallpaper.value})`,
                backgroundSize: 'cover',
                backgroundPosition: 'center'
            };
        }
        return { background: currentWallpaper.value };
    };

    const handleRoleChange = (memberId, newRole) => {
        if (!selectedGroup) return;
        setGroupMembers(prev => ({
            ...prev,
            [selectedGroup.id]: prev[selectedGroup.id].map(m =>
                m.id === memberId ? { ...m, role: newRole } : m
            )
        }));
        setActiveMemberMenu(null);
    };

    const handleRemoveMember = (memberId) => {
        if (!selectedGroup) return;
        setConfirmModal({
            isOpen: true,
            type: 'remove_member',
            title: 'Ãœyeyi Ã‡Ä±kar',
            message: 'Bu Ã¼yeyi gruptan Ã§Ä±karmak istediÄŸinize emin misiniz?',
            data: memberId
        });
        setActiveMemberMenu(null);
    };

    const containerStyle = {
        '--theme-primary': currentTheme.primary,
        '--theme-secondary': currentTheme.secondary,
        '--theme-gradient': currentTheme.gradient,
    };

    if (!user) {
        return (
            <div className={`groups-login-prompt ${isDarkMode ? 'dark' : 'light'}`}>
                <div className="login-card">
                    <div className="login-icon">
                        <Users size={64} />
                    </div>
                    <h2>Gruplara HoÅŸ Geldiniz</h2>
                    <p>Gruplara eriÅŸmek iÃ§in lÃ¼tfen giriÅŸ yapÄ±n</p>
                </div>
            </div>
        );
    }

    return (
        <div className={`groups-container-enhanced ${isDarkMode ? 'dark' : 'light'}`} style={containerStyle}>
            {/* Animated Background */}
            <div className="animated-bg">
                <div className="bg-orb bg-orb-1" style={{ background: currentTheme.primary }}></div>
                <div className="bg-orb bg-orb-2" style={{ background: currentTheme.secondary }}></div>
                <div className="bg-orb bg-orb-3" style={{ background: currentTheme.primary }}></div>
            </div>

            {/* Sidebar */}
            <div className="groups-sidebar">
                {/* Header */}
                <div className="sidebar-header-enhanced">
                    <div className="header-row">
                        <div className="logo-section">
                            <div className="logo-icon" style={{ background: currentTheme.gradient }}>
                                <Users size={22} />
                            </div>
                            <h1>Gruplar</h1>
                        </div>
                        <div className="header-actions">
                            <button className="icon-btn-modern" onClick={() => setIsDarkMode(!isDarkMode)}>
                                {isDarkMode ? <Sun size={18} /> : <Moon size={18} />}
                            </button>
                            <button className="icon-btn-modern" onClick={() => setShowSettings(true)}>
                                <Palette size={18} />
                            </button>
                        </div>
                    </div>

                    {/* Search */}
                    <div className="search-container">
                        <Search size={18} />
                        <input
                            type="text"
                            placeholder="Grup ara..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>

                    {/* Action Buttons */}
                    <div className="action-row">
                        <button className="action-btn-primary" onClick={() => setShowCreateModal(true)} style={{ background: currentTheme.gradient }}>
                            <Plus size={18} />
                            <span>Yeni Grup</span>
                        </button>
                        <button className="action-btn-secondary" onClick={() => setShowJoinModal(true)}>
                            <LogIn size={18} />
                            <span>KatÄ±l</span>
                        </button>
                    </div>
                </div>

                {/* Filter Tabs */}
                <div className="filter-tabs-enhanced">
                    {[
                        { key: 'all', label: 'TÃ¼mÃ¼', count: groups.length },
                        { key: 'pinned', label: 'Sabitler', icon: Star, count: groups.filter(g => g.isPinned).length },
                        { key: 'admin', label: 'YÃ¶netici', icon: Crown, count: groups.filter(g => g.isAdmin).length },
                    ].map(tab => (
                        <button
                            key={tab.key}
                            className={`filter-tab-enhanced ${filter === tab.key ? 'active' : ''}`}
                            onClick={() => setFilter(tab.key)}
                            style={filter === tab.key ? { borderColor: currentTheme.primary, color: currentTheme.primary } : {}}
                        >
                            {tab.icon && <tab.icon size={14} />}
                            {tab.label}
                            <span className="tab-count">{tab.count}</span>
                        </button>
                    ))}
                </div>

                {/* Group List */}
                <div className="groups-list">
                    {filteredGroups.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-icon" style={{ background: `${currentTheme.primary}20` }}>
                                <Users size={48} style={{ color: currentTheme.primary }} />
                            </div>
                            <p>HenÃ¼z grup yok</p>
                            <span>Yeni bir grup oluÅŸturun veya mevcut bir gruba katÄ±lÄ±n</span>
                        </div>
                    ) : (
                        filteredGroups.map(group => (
                            <div
                                key={group.id}
                                className={`group-item ${selectedGroup?.id === group.id ? 'active' : ''} ${group.isPinned ? 'pinned' : ''}`}
                                onClick={() => {
                                    setSelectedGroup(group);
                                    setGroups(prev => prev.map(g =>
                                        g.id === group.id ? { ...g, unread: 0 } : g
                                    ));
                                }}
                            >
                                {group.isPinned && <div className="pin-indicator"><Star size={10} /></div>}
                                <div className="group-avatar" style={{ background: `linear-gradient(135deg, ${group.color}, ${group.color}aa)` }}>
                                    <Users size={20} />
                                    <div className="online-dot" style={{ background: group.onlineCount > 0 ? '#22c55e' : '#64748b' }}></div>
                                </div>
                                <div className="group-info">
                                    <div className="group-row">
                                        <span className="group-name">
                                            {group.name}
                                            {group.isAdmin && <Crown size={12} className="admin-badge" />}
                                        </span>
                                        <span className="group-time">{getTimeAgo(group.lastMessageTime)}</span>
                                    </div>
                                    <div className="group-row">
                                        <span className="group-preview">
                                            <span className="sender-name">{group.lastMessageSender}:</span> {group.lastMessage}
                                        </span>
                                        {group.unread > 0 && (
                                            <span className="unread-count" style={{ background: currentTheme.gradient }}>{group.unread}</span>
                                        )}
                                    </div>
                                    <div className="group-meta">
                                        <span><Users size={12} /> {group.memberCount}</span>
                                        <span className="online-count">â€¢ {group.onlineCount} Ã§evrimiÃ§i</span>
                                    </div>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>

            {/* Main Content */}
            <div className="groups-main" style={getWallpaperStyle()}>
                {!selectedGroup ? (
                    <div className="no-group-selected">
                        <div className="welcome-card">
                            <div className="welcome-icon" style={{ background: currentTheme.gradient }}>
                                <Sparkles size={48} />
                            </div>
                            <h2>Grup Sohbetine HoÅŸ Geldiniz! ðŸ‘‹</h2>
                            <p>Sohbete baÅŸlamak iÃ§in soldaki listeden bir grup seÃ§in</p>
                            <div className="welcome-features">
                                <div className="feature-item">
                                    <MessageCircle size={20} style={{ color: currentTheme.primary }} />
                                    <span>Grup Sohbeti</span>
                                </div>
                                <div className="feature-item">
                                    <Image size={20} style={{ color: currentTheme.primary }} />
                                    <span>Medya PaylaÅŸÄ±mÄ±</span>
                                </div>
                                <div className="feature-item">
                                    <Users size={20} style={{ color: currentTheme.primary }} />
                                    <span>Ãœye YÃ¶netimi</span>
                                </div>
                            </div>
                        </div>
                    </div>
                ) : (
                    <>
                        {/* Chat Header */}
                        <div className="chat-header-enhanced">
                            <button className="back-btn-mobile" onClick={() => setSelectedGroup(null)}>
                                <ArrowLeft size={24} />
                            </button>
                            <div className="chat-info" onClick={() => setShowGroupInfo(true)}>
                                <div className="chat-avatar" style={{ background: `linear-gradient(135deg, ${selectedGroup.color}, ${selectedGroup.color}aa)` }}>
                                    <Users size={24} />
                                </div>
                                <div className="chat-details">
                                    <h3>
                                        {selectedGroup.name}
                                        {selectedGroup.isAdmin && <Crown size={14} className="crown-badge" style={{ color: '#fbbf24' }} />}
                                    </h3>
                                    <span className="chat-status">
                                        {selectedGroup.memberCount} Ã¼ye â€¢ {selectedGroup.onlineCount} Ã§evrimiÃ§i
                                    </span>
                                </div>
                            </div>
                            <div className="chat-header-actions">
                                <button className="header-action-btn" onClick={() => setShowMembersModal(true)}>
                                    <Users size={20} />
                                </button>
                                <button className="header-action-btn" onClick={() => startCall('video')} title="GÃ¶rÃ¼ntÃ¼lÃ¼ Arama">
                                    <Video size={20} />
                                </button>
                                <button className="header-action-btn" onClick={() => startCall('voice')} title="Sesli Arama">
                                    <Phone size={20} />
                                </button>
                                <button className="header-action-btn" onClick={() => togglePin(selectedGroup.id)}>
                                    <Star size={20} fill={selectedGroup.isPinned ? 'currentColor' : 'none'} />
                                </button>
                                <div className="options-menu-wrapper">
                                    <button
                                        className="header-action-btn"
                                        onClick={() => setShowOptionsMenu(!showOptionsMenu)}
                                    >
                                        <MoreVertical size={20} />
                                    </button>
                                    {showOptionsMenu && (
                                        <div className="options-dropdown">
                                            <button
                                                className="options-dropdown-item"
                                                onClick={() => toggleMuteGroup(selectedGroup.id)}
                                            >
                                                {mutedGroups.includes(selectedGroup.id) ? <Bell size={16} /> : <BellOff size={16} />}
                                                {mutedGroups.includes(selectedGroup.id) ? 'Bildirimleri AÃ§' : 'Bildirimleri Kapat'}
                                            </button>
                                            <button
                                                className="options-dropdown-item"
                                                onClick={() => deleteGroupChat(selectedGroup.id)}
                                            >
                                                <Trash2 size={16} />
                                                Sohbeti Sil
                                            </button>
                                            <button
                                                className="options-dropdown-item danger"
                                                onClick={() => leaveGroup(selectedGroup.id)}
                                            >
                                                <LogOut size={16} />
                                                Gruptan AyrÄ±l
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>


                        {/* Messages */}
                        <div className="messages-area" onClick={() => setShowEmojiPicker(false)}>
                            {(messages[selectedGroup.id] || []).map((msg, index) => {
                                if (msg.type === 'call-log') {
                                    return (
                                        <div key={msg.id} className="message-call-log group-call-log">
                                            <div className="call-log-content">
                                                {msg.callType === 'video' ? <Video size={16} /> : <Phone size={16} />}
                                                <span>{msg.content}</span>
                                            </div>
                                            <span className="call-log-time">{msg.time}</span>
                                        </div>
                                    );
                                }
                                return (
                                    <div key={msg.id} className={`message-wrapper ${msg.isMe ? 'sent' : 'received'}`}>
                                        {!msg.isMe && (
                                            <div className="sender-avatar" style={{ background: `linear-gradient(135deg, ${selectedGroup.color}, ${selectedGroup.color}aa)` }}>
                                                {msg.senderAvatar || msg.senderName?.charAt(0)}
                                            </div>
                                        )}
                                        <div className="message-content">
                                            {!msg.isMe && (
                                                <span className="sender-name-tag" style={{ color: selectedGroup.color }}>{msg.senderName}</span>
                                            )}
                                            <div className={`message-bubble-enhanced ${msg.isMe ? 'sent' : 'received'} ${msg.image || msg.sticker ? 'has-media' : ''}`}
                                                style={msg.isMe && !msg.image && !msg.sticker ? { background: currentTheme.gradient } : {}}>
                                                {msg.image && <img src={msg.image} alt="FotoÄŸraf" className="message-media" />}
                                                {msg.sticker && <img src={msg.sticker} alt={msg.stickerName} className="message-sticker" />}
                                                {msg.content && <p>{msg.content}</p>}
                                                <span className="message-time-enhanced">{msg.time}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}

                            {/* Typing Indicator */}
                            {typingUsers.length > 0 && selectedGroup.id === 'g1' && (
                                <div className="typing-indicator-enhanced">
                                    <div className="typing-avatar" style={{ background: `linear-gradient(135deg, ${selectedGroup.color}, ${selectedGroup.color}aa)` }}>Z</div>
                                    <div className="typing-bubble">
                                        <span>{typingUsers.join(', ')} yazÄ±yor</span>
                                        <div className="typing-dots">
                                            <div className="dot"></div>
                                            <div className="dot"></div>
                                            <div className="dot"></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div ref={messagesEndRef} />
                        </div>

                        {/* Emoji Picker */}
                        {showEmojiPicker && (
                            <div className="emoji-picker-enhanced">
                                <div className="picker-header">
                                    <button className={`picker-tab ${emojiTab === 'emoji' ? 'active' : ''}`} onClick={() => setEmojiTab('emoji')}>ðŸ˜€ Emoji</button>
                                    <button className={`picker-tab ${emojiTab === 'sticker' ? 'active' : ''}`} onClick={() => setEmojiTab('sticker')}>ðŸŽ­ Ã‡Ä±kartma</button>
                                    <button className="picker-close" onClick={() => setShowEmojiPicker(false)}><X size={18} /></button>
                                </div>
                                {emojiTab === 'emoji' ? (
                                    <>
                                        <div className="emoji-categories-bar">
                                            <button className={`cat-btn ${emojiCategory === 'favorites' ? 'active' : ''}`} onClick={() => setEmojiCategory('favorites')}>â­</button>
                                            {Object.entries(EMOJI_CATEGORIES).map(([key, cat]) => (
                                                <button key={key} className={`cat-btn ${emojiCategory === key ? 'active' : ''}`} onClick={() => setEmojiCategory(key)}>{cat.icon}</button>
                                            ))}
                                        </div>
                                        <div className="emojis-grid">
                                            {emojiCategory === 'favorites' ? (
                                                favoriteEmojis.map((emoji, i) => (
                                                    <button key={i} className="emoji-item" onClick={() => addEmoji(emoji)}>{emoji}</button>
                                                ))
                                            ) : (
                                                EMOJI_CATEGORIES[emojiCategory]?.emojis.map((emoji, i) => (
                                                    <button key={i} className="emoji-item" onClick={() => addEmoji(emoji)}>{emoji}</button>
                                                ))
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <div className="stickers-grid">
                                        {STICKERS.map(sticker => (
                                            <button key={sticker.id} className="sticker-item" onClick={() => sendSticker(sticker)}>
                                                <img src={sticker.url} alt={sticker.name} />
                                                <span>{sticker.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Input Area */}
                        <form className="input-area-enhanced" onSubmit={handleSendMessage}>
                            <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept="image/*,.pdf,.doc,.docx" style={{ display: 'none' }} />
                            <div className="input-actions">
                                <button type="button" className="input-btn" onClick={() => fileInputRef.current?.click()}><Paperclip size={20} /></button>
                            </div>
                            <div className="input-wrapper">
                                <input
                                    type="text"
                                    placeholder="Mesaj yaz..."
                                    value={inputMessage}
                                    onChange={(e) => setInputMessage(e.target.value)}
                                />
                            </div>
                            <div className="input-actions">
                                <button type="button" className={`input-btn ${showEmojiPicker ? 'active' : ''}`} onClick={() => setShowEmojiPicker(!showEmojiPicker)}><Smile size={20} /></button>
                                <button type="submit" className="send-btn-enhanced" disabled={!inputMessage.trim()} style={{ background: currentTheme.gradient }}>
                                    <Send size={20} />
                                </button>
                            </div>
                        </form>
                    </>
                )}
            </div>

            {/* Settings Modal */}
            {showSettings && (
                <div className="modal-overlay-enhanced" onClick={() => setShowSettings(false)}>
                    <div className="modal-enhanced settings-modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header-enhanced">
                            <h2><Palette size={20} /> GÃ¶rÃ¼nÃ¼m AyarlarÄ±</h2>
                            <button onClick={() => setShowSettings(false)}><X size={24} /></button>
                        </div>
                        <div className="modal-content">
                            <div className="setting-group">
                                <h3>Tema</h3>
                                <div className="theme-buttons">
                                    <button className={`theme-option ${!isDarkMode ? 'active' : ''}`} onClick={() => setIsDarkMode(false)}><Sun size={18} /> GÃ¼ndÃ¼z</button>
                                    <button className={`theme-option ${isDarkMode ? 'active' : ''}`} onClick={() => setIsDarkMode(true)}><Moon size={18} /> Gece</button>
                                </div>
                            </div>
                            <div className="setting-group">
                                <h3>Renk TemasÄ±</h3>
                                <div className="colors-grid">
                                    {COLOR_THEMES.map(theme => (
                                        <button key={theme.id} className={`color-item ${selectedColorTheme === theme.id ? 'active' : ''}`} style={{ background: theme.gradient }} onClick={() => setSelectedColorTheme(theme.id)}>
                                            {selectedColorTheme === theme.id && <Check size={16} />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="setting-group">
                                <h3>Duvar KaÄŸÄ±dÄ±</h3>
                                <div className="wallpapers-grid">
                                    {WALLPAPERS.map(wp => (
                                        <button key={wp.id} className={`wallpaper-item ${selectedWallpaper === wp.id ? 'active' : ''}`} style={wp.type === 'image' ? { backgroundImage: `url(${wp.value})`, backgroundSize: 'cover' } : { background: wp.value }} onClick={() => setSelectedWallpaper(wp.id)}>
                                            <span>{wp.name}</span>
                                            {selectedWallpaper === wp.id && <Check size={14} />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Create Group Modal */}
            {showCreateModal && (
                <div className="modal-overlay-enhanced" onClick={() => setShowCreateModal(false)}>
                    <div className="modal-enhanced" onClick={e => e.stopPropagation()}>
                        <div className="modal-header-enhanced">
                            <h2><Plus size={20} /> Yeni Grup OluÅŸtur</h2>
                            <button onClick={() => setShowCreateModal(false)}><X size={24} /></button>
                        </div>
                        <div className="modal-content">
                            <div className="form-group">
                                <label>Grup AdÄ±</label>
                                <input type="text" value={newGroupName} onChange={e => setNewGroupName(e.target.value)} placeholder="Harika bir isim girin..." />
                            </div>
                            <div className="form-group">
                                <label>AÃ§Ä±klama</label>
                                <textarea value={newGroupDescription} onChange={e => setNewGroupDescription(e.target.value)} placeholder="Bu grup ne hakkÄ±nda?" />
                            </div>
                            <div className="form-group">
                                <label>Åžifre (opsiyonel)</label>
                                <input type="password" value={newGroupPassword} onChange={e => setNewGroupPassword(e.target.value)} placeholder="Gizli grup iÃ§in ÅŸifre ekleyin" />
                            </div>
                            <button className="submit-btn-enhanced" style={{ background: currentTheme.gradient }} onClick={handleCreateGroup}>
                                <Sparkles size={18} /> Grubu OluÅŸtur
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Join Group Modal */}
            {showJoinModal && (
                <div className="modal-overlay-enhanced" onClick={() => setShowJoinModal(false)}>
                    <div className="modal-enhanced" onClick={e => e.stopPropagation()}>
                        <div className="modal-header-enhanced">
                            <h2><LogIn size={20} /> Gruba KatÄ±l</h2>
                            <button onClick={() => setShowJoinModal(false)}><X size={24} /></button>
                        </div>
                        <div className="modal-content">
                            <div className="form-group">
                                <label>Grup AdÄ± veya Kodu</label>
                                <input type="text" value={joinGroupName} onChange={e => setJoinGroupName(e.target.value)} placeholder="Grup adÄ±nÄ± veya davet kodunu girin" />
                            </div>
                            <div className="form-group">
                                <label>Grup Åžifresi</label>
                                <input type="password" value={joinGroupPassword} onChange={e => setJoinGroupPassword(e.target.value)} placeholder="Gizli gruplar iÃ§in ÅŸifre gerekli" />
                            </div>
                            <button className="submit-btn-enhanced" style={{ background: currentTheme.gradient }} onClick={handleJoinGroup}>
                                <Users size={18} /> Gruba KatÄ±l
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Members Modal */}
            {showMembersModal && selectedGroup && (
                <div className="modal-overlay-enhanced" onClick={() => setShowMembersModal(false)}>
                    <div className="modal-enhanced members-modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header-enhanced">
                            <h2><Users size={20} /> Grup Ãœyeleri</h2>
                            <button onClick={() => setShowMembersModal(false)}><X size={24} /></button>
                        </div>
                        <div className="modal-content">
                            <div className="members-search">
                                <Search size={18} />
                                <input
                                    type="text"
                                    placeholder="Ãœye ara..."
                                    value={memberSearchQuery}
                                    onChange={(e) => setMemberSearchQuery(e.target.value)}
                                />
                            </div>
                            <div className="members-list">
                                {filteredMembers.map(member => (
                                    <div key={member.id} className="member-item">
                                        <div className="member-avatar" style={{ background: `linear-gradient(135deg, ${selectedGroup.color}, ${selectedGroup.color}aa)` }}>
                                            {member.avatar}
                                            <div className={`status-dot ${member.online ? 'online' : ''}`}></div>
                                        </div>
                                        <div className="member-info">
                                            <div className="member-name">
                                                {member.name}
                                                {member.role === 'admin' && <span className="role-badge admin"><Crown size={10} /> YÃ¶netici</span>}
                                                {member.role === 'moderator' && <span className="role-badge mod"><Shield size={10} /> ModeratÃ¶r</span>}
                                            </div>
                                            <div className="member-status">
                                                {member.status || member.lastSeen}
                                            </div>
                                        </div>
                                        {selectedGroup.isAdmin && (
                                            <div style={{ position: 'relative' }}>
                                                <button
                                                    className="member-action-btn"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setActiveMemberMenu(activeMemberMenu === member.id ? null : member.id);
                                                    }}
                                                >
                                                    <MoreVertical size={18} />
                                                </button>
                                                {activeMemberMenu === member.id && (
                                                    <div className="member-role-menu">
                                                        <button onClick={() => handleRoleChange(member.id, 'admin')} className={member.role === 'admin' ? 'active' : ''}>
                                                            <Crown size={14} /> YÃ¶netici Yap
                                                        </button>
                                                        <button onClick={() => handleRoleChange(member.id, 'moderator')} className={member.role === 'moderator' ? 'active' : ''}>
                                                            <Shield size={14} /> ModeratÃ¶r Yap
                                                        </button>
                                                        <button onClick={() => handleRoleChange(member.id, 'member')} className={member.role === 'member' ? 'active' : ''}>
                                                            <Users size={14} /> Ãœye Yap
                                                        </button>
                                                        <div className="menu-divider"></div>
                                                        <button className="delete-action" onClick={() => handleRemoveMember(member.id)}>
                                                            <UserMinus size={14} /> Gruptan Ã‡Ä±kar
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            {selectedGroup.isAdmin && (
                                <button
                                    className="add-member-btn"
                                    style={{ background: currentTheme.gradient }}
                                    onClick={handleAddMember}
                                >
                                    <UserPlus size={18} /> Ãœye Ekle
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            )}


            {/* Call Modal */}
            {
                showCallModal && (
                    <div className="call-modal-overlay">
                        <div className="call-modal">
                            <div className="call-header">
                                <div className="call-status">
                                    {callStatus === 'calling' ? 'AranÄ±yor...' : callStatus === 'ended' ? 'Arama SonlandÄ±' : 'BaÄŸlandÄ±'}
                                </div>
                                {callStatus === 'connected' && (
                                    <div className="call-duration">{formatDuration(callDuration)}</div>
                                )}
                            </div>

                            <div className="call-user-info">
                                {callType === 'video' ? (
                                    <div className="call-video-container">
                                        <video
                                            ref={localVideoRef}
                                            autoPlay
                                            muted
                                            playsInline
                                            className="call-video"
                                        />
                                        <div className="call-overlay-name">{selectedGroup?.name}</div>
                                    </div>
                                ) : (
                                    <>
                                        <div className="call-avatar-wrapper">
                                            <div className="call-avatar" style={{
                                                background: selectedGroup?.color || currentTheme.gradient
                                            }}>
                                                {selectedGroup?.avatar}
                                            </div>
                                            <div className="call-avatar-pulse" style={{ borderColor: selectedGroup?.color || currentTheme.primary }}></div>
                                        </div>
                                        <h2>{selectedGroup?.name}</h2>
                                    </>
                                )}
                                <p>{callType === 'video' ? 'GÃ¶rÃ¼ntÃ¼lÃ¼ Grup AramasÄ±' : 'Sesli Grup AramasÄ±'}</p>
                            </div>

                            <div className="call-controls">
                                <button className="control-btn" title="Mikrofon">
                                    <Mic size={24} />
                                </button>
                                {callType === 'video' && (
                                    <button className="control-btn" title="Kamera">
                                        <Video size={24} />
                                    </button>
                                )}
                                <button className="control-btn end-call" onClick={endCall} title="SonlandÄ±r">
                                    <PhoneOff size={28} />
                                </button>
                            </div>
                        </div>
                    </div>
                )
            }
            {/* Confirmation Modal */}
            {confirmModal.isOpen && (
                <div className="confirmation-modal-overlay absolute" onClick={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}>
                    <div className="confirmation-modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-icon">
                            {confirmModal.type === 'delete' ? <Trash2 size={32} /> :
                                confirmModal.type === 'leave' ? <LogOut size={32} /> :
                                    <UserMinus size={32} />}
                        </div>
                        <h3>{confirmModal.title}</h3>
                        <div className="modal-message-box">
                            <p>{confirmModal.message}</p>
                        </div>
                        <div className="modal-actions">
                            <button
                                className="modal-btn cancel"
                                onClick={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                            >
                                VazgeÃ§
                            </button>
                            <button
                                className="modal-btn confirm"
                                onClick={handleConfirmAction}
                            >
                                {confirmModal.type === 'delete' ? 'Sil' :
                                    confirmModal.type === 'leave' ? 'AyrÄ±l' : 'Ã‡Ä±kar'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Member Modal */}
            {showAddMemberModal && (
                <div className="confirmation-modal-overlay absolute" onClick={() => setShowAddMemberModal(false)}>
                    <div className="confirmation-modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header-simple" style={{ marginBottom: '20px', textAlign: 'center' }}>
                            <div className="modal-icon generic" style={{ background: currentTheme.gradient, color: 'white', margin: '0 auto 15px' }}>
                                <UserPlus size={32} />
                            </div>
                            <h3>Ãœye Ekle</h3>
                        </div>

                        <div className="modal-body">
                            <input
                                type="text"
                                placeholder="KullanÄ±cÄ± AdÄ± Ara..."
                                value={newMemberName}
                                onChange={(e) => {
                                    setNewMemberName(e.target.value);
                                    // Filter mock users
                                    if (e.target.value.trim()) {
                                        const results = PREDEFINED_USERS.filter(u =>
                                            u.name.toLowerCase().includes(e.target.value.toLowerCase()) &&
                                            !currentGroupMembers.some(m => m.name === u.name) // Don't show already added members
                                        );
                                        setSearchResults(results);
                                    } else {
                                        setSearchResults([]);
                                    }
                                }}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    borderRadius: '12px',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    background: 'rgba(255,255,255,0.05)',
                                    color: 'white',
                                    outline: 'none',
                                    fontSize: '16px',
                                    marginBottom: searchResults.length > 0 ? '10px' : '0'
                                }}
                                autoFocus
                            />

                            {/* Search Results */}
                            {searchResults.length > 0 && (
                                <div className="search-results" style={{
                                    maxHeight: '200px',
                                    overflowY: 'auto',
                                    background: 'rgba(0,0,0,0.2)',
                                    borderRadius: '12px',
                                    padding: '5px'
                                }}>
                                    {searchResults.map(user => (
                                        <div
                                            key={user.id}
                                            className="search-result-item"
                                            onClick={() => {
                                                handleAddSpecificMember(user);
                                                setShowAddMemberModal(false);
                                                setNewMemberName('');
                                                setSearchResults([]);
                                            }}
                                            style={{
                                                padding: '10px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '10px',
                                                cursor: 'pointer',
                                                borderRadius: '8px',
                                                transition: 'background 0.2s'
                                            }}
                                            onMouseEnter={e => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}
                                            onMouseLeave={e => e.currentTarget.style.background = 'transparent'}
                                        >
                                            <div className="result-avatar" style={{
                                                width: '32px',
                                                height: '32px',
                                                borderRadius: '50%',
                                                background: currentTheme.gradient,
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '14px',
                                                fontWeight: '600'
                                            }}>
                                                {user.avatar}
                                            </div>
                                            <div className="result-info">
                                                <div className="result-name" style={{ fontWeight: '500' }}>{user.name}</div>
                                                <div className="result-status" style={{ fontSize: '12px', opacity: 0.7 }}>{user.status}</div>
                                            </div>
                                            <Plus size={16} style={{ marginLeft: 'auto', opacity: 0.7 }} />
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="modal-actions" style={{ marginTop: '20px' }}>
                            <button
                                className="modal-btn cancel"
                                onClick={() => {
                                    setShowAddMemberModal(false);
                                    setNewMemberName('');
                                    setSearchResults([]);
                                }}
                            >
                                VazgeÃ§
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default GroupsPage;
