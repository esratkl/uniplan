import React, { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import io from 'socket.io-client';
import { useAuth } from '../context/AuthContext';
import {
    Send, Search, Users, UserPlus, X, Check,
    MessageCircle, Circle, MoreVertical, Phone, Video,
    Smile, Paperclip, ArrowLeft, Settings, Moon, Sun, Image, Palette,
    Star, PhoneOff, Mic, MicOff, VideoOff, ArrowDownLeft, ArrowUpRight,
    Ban, Trash2, LogOut, Bell, BellOff
} from 'lucide-react';
import '../styles/Chat.css';

const API_URL = process.env.REACT_APP_API_URL || '';

// Wallpaper options with images
const WALLPAPERS = [
    { id: 'default', name: 'VarsayÄ±lan', type: 'gradient', value: 'transparent' },
    { id: 'mountains', name: 'DaÄŸlar', type: 'image', value: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80' },
    { id: 'ocean', name: 'Okyanus', type: 'image', value: 'https://images.unsplash.com/photo-1518837695005-2083093ee35b?w=1920&q=80' },
    { id: 'forest', name: 'Orman', type: 'image', value: 'https://images.unsplash.com/photo-1448375240586-882707db888b?w=1920&q=80' },
    { id: 'galaxy', name: 'Galaksi', type: 'image', value: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=1920&q=80' },
    { id: 'sunset', name: 'GÃ¼n BatÄ±mÄ±', type: 'image', value: 'https://images.unsplash.com/photo-1495616811223-4d98c6e9c869?w=1920&q=80' },
    { id: 'city', name: 'Åžehir', type: 'image', value: 'https://images.unsplash.com/photo-1519501025264-65ba15a82390?w=1920&q=80' },
    { id: 'aurora', name: 'Kuzey IÅŸÄ±klarÄ±', type: 'image', value: 'https://images.unsplash.com/photo-1531366936337-7c912a4589a7?w=1920&q=80' },
];

// Color themes for messages
const COLOR_THEMES = [
    { id: 'purple', name: 'Mor', primary: '#8b5cf6', secondary: '#6366f1' },
    { id: 'blue', name: 'Mavi', primary: '#3b82f6', secondary: '#0ea5e9' },
    { id: 'green', name: 'YeÅŸil', primary: '#22c55e', secondary: '#10b981' },
    { id: 'pink', name: 'Pembe', primary: '#ec4899', secondary: '#f472b6' },
    { id: 'orange', name: 'Turuncu', primary: '#f97316', secondary: '#fb923c' },
    { id: 'red', name: 'KÄ±rmÄ±zÄ±', primary: '#ef4444', secondary: '#f87171' },
    { id: 'teal', name: 'Turkuaz', primary: '#14b8a6', secondary: '#2dd4bf' },
    { id: 'indigo', name: 'Ä°ndigo', primary: '#6366f1', secondary: '#818cf8' },
];

const ChatPage = () => {
    const { user } = useAuth();
    const [socket, setSocket] = useState(null);
    const [isConnected, setIsConnected] = useState(false);

    // Theme & Customization
    const [isDarkMode, setIsDarkMode] = useState(true);
    const [selectedWallpaper, setSelectedWallpaper] = useState('galaxy');
    const [selectedColorTheme, setSelectedColorTheme] = useState('purple');
    const [showSettings, setShowSettings] = useState(false);

    // Options Menu
    const [showOptionsMenu, setShowOptionsMenu] = useState(false);
    const [blockedUsers, setBlockedUsers] = useState([]);
    const [mutedChats, setMutedChats] = useState([]);
    const [menuPosition, setMenuPosition] = useState({ top: 0, right: 0 });

    // Modal States
    const [confirmModal, setConfirmModal] = useState({
        isOpen: false,
        type: null, // 'delete' or 'leave'
        title: '',
        message: '',
        data: null
    });

    // Friends & Conversations
    const [friends, setFriends] = useState([
        { id: 'f1', name: 'Ali YÄ±lmaz', username: 'aliyilmaz', avatar: 'AY', online: true, lastMessage: 'Merhaba!', lastMessageTime: new Date(), unread: 2, isFavorite: true },
        { id: 'f2', name: 'Zeynep Demir', username: 'zeynepd', avatar: 'ZD', online: true, lastMessage: 'Proje nasÄ±l gidiyor?', lastMessageTime: new Date(Date.now() - 3600000), unread: 0, isFavorite: false },
        { id: 'f3', name: 'Mehmet Kaya', username: 'mehmetk', avatar: 'MK', online: false, lastMessage: 'GÃ¶rÃ¼ÅŸÃ¼rÃ¼z!', lastMessageTime: new Date(Date.now() - 86400000), unread: 0, isFavorite: true },
        { id: 'f4', name: 'AyÅŸe Ã‡elik', username: 'aysecelik', avatar: 'AÃ‡', online: true, lastMessage: 'TeÅŸekkÃ¼rler ðŸ˜Š', lastMessageTime: new Date(Date.now() - 7200000), unread: 1, isFavorite: false },
        { id: 'f5', name: 'Can YÄ±ldÄ±z', username: 'canyildiz', avatar: 'CY', online: false, lastMessage: 'Tamam, anlaÅŸtÄ±k!', lastMessageTime: new Date(Date.now() - 172800000), unread: 0, isFavorite: false },
    ]);

    // Call States
    const [showCallModal, setShowCallModal] = useState(false);
    const [callType, setCallType] = useState('voice'); // 'voice' or 'video'
    const [callStatus, setCallStatus] = useState('calling'); // 'calling', 'connected', 'ended'
    const [callDuration, setCallDuration] = useState(0);
    const localVideoRef = useRef(null);
    const optionsMenuRef = useRef(null);

    // Call Effect for Camera
    useEffect(() => {
        let stream = null;

        const startCamera = async () => {
            if (showCallModal && callType === 'video') {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    if (localVideoRef.current) {
                        localVideoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error("Kamera hatasÄ±:", err);
                    alert("Kamera eriÅŸimi saÄŸlanamadÄ±. LÃ¼tfen izinleri kontrol edin.");
                }
            }
        };

        startCamera();

        return () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        };
    }, [showCallModal, callType]);

    // Click outside to close options menu
    useEffect(() => {
        const handleClickOutside = (event) => {
            // Check if click is outside both the menu (portal) and the toggle button
            if (showOptionsMenu &&
                optionsMenuRef.current &&
                !optionsMenuRef.current.contains(event.target) &&
                !event.target.closest('.options-menu-portal')) {
                setShowOptionsMenu(false);
            }
        };

        if (showOptionsMenu) {
            document.addEventListener('mousedown', handleClickOutside);
            window.addEventListener('scroll', () => setShowOptionsMenu(false), true); // Close on scroll
            window.addEventListener('resize', () => setShowOptionsMenu(false)); // Close on resize
        }

        return () => {
            document.removeEventListener('mousedown', handleClickOutside);
            window.removeEventListener('scroll', () => setShowOptionsMenu(false), true);
            window.removeEventListener('resize', () => setShowOptionsMenu(false));
        };
    }, [showOptionsMenu]);

    const [selectedFriend, setSelectedFriend] = useState(null);
    const [filter, setFilter] = useState('all');
    const [searchQuery, setSearchQuery] = useState('');

    // Messages
    const [messages, setMessages] = useState({});
    const [inputMessage, setInputMessage] = useState('');
    const messagesEndRef = useRef(null);

    // Modals
    const [showNewMessageModal, setShowNewMessageModal] = useState(false);
    const [userSearchQuery, setUserSearchQuery] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [pendingRequests, setPendingRequests] = useState([]);

    // Emoji & File Upload
    const [showEmojiPicker, setShowEmojiPicker] = useState(false);
    const [emojiTab, setEmojiTab] = useState('emoji'); // 'emoji' or 'sticker'
    const [emojiCategory, setEmojiCategory] = useState('smileys');
    const fileInputRef = useRef(null);

    // Emoji categories
    const emojiCategories = {
        smileys: {
            icon: 'ðŸ˜€',
            name: 'YÃ¼zler',
            emojis: ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ¤£', 'ðŸ˜‚', 'ðŸ™‚', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ¥°', 'ðŸ˜', 'ðŸ¤©', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜š', 'ðŸ˜™', 'ðŸ¥²', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ˜', 'ðŸ¤‘', 'ðŸ¤—', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤”', 'ðŸ¤', 'ðŸ¤¨', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜’', 'ðŸ™„', 'ðŸ˜¬', 'ðŸ˜®â€ðŸ’¨', 'ðŸ¤¥', 'ðŸ˜Œ', 'ðŸ˜”', 'ðŸ˜ª', 'ðŸ¤¤', 'ðŸ˜´', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ¥´', 'ðŸ˜µ', 'ðŸ¤¯', 'ðŸ¤ ', 'ðŸ¥³', 'ðŸ¥¸', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ§']
        },
        emotions: {
            icon: 'â¤ï¸',
            name: 'Duygular',
            emojis: ['ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜¤', 'ðŸ˜ ', 'ðŸ˜¡', 'ðŸ¤¬', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ’€', 'â˜ ï¸', 'ðŸ’©', 'ðŸ¤¡', 'ðŸ‘¹', 'ðŸ‘º', 'ðŸ‘»', 'ðŸ‘½', 'ðŸ‘¾', 'ðŸ¤–', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¾', 'â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ–¤', 'ðŸ¤', 'ðŸ¤Ž', 'ðŸ’”', 'â¤ï¸â€ðŸ”¥', 'â¤ï¸â€ðŸ©¹', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’Ÿ']
        },
        gestures: {
            icon: 'ðŸ‘‹',
            name: 'El Hareketleri',
            emojis: ['ðŸ‘‹', 'ðŸ¤š', 'ðŸ–ï¸', 'âœ‹', 'ðŸ––', 'ðŸ‘Œ', 'ðŸ¤Œ', 'ðŸ¤', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ–•', 'ðŸ‘‡', 'â˜ï¸', 'ðŸ‘', 'ðŸ‘Ž', 'âœŠ', 'ðŸ‘Š', 'ðŸ¤›', 'ðŸ¤œ', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ‘', 'ðŸ¤²', 'ðŸ¤', 'ðŸ™', 'âœï¸', 'ðŸ’…', 'ðŸ¤³', 'ðŸ’ª', 'ðŸ¦¾', 'ðŸ¦¿']
        },
        objects: {
            icon: 'ðŸŽ‰',
            name: 'Nesneler',
            emojis: ['ðŸŽ‰', 'ðŸŽŠ', 'ðŸŽ', 'ðŸŽˆ', 'ðŸŽ€', 'ðŸŽ„', 'ðŸŽƒ', 'ðŸŽ—ï¸', 'ðŸŽŸï¸', 'ðŸŽ«', 'ðŸ”®', 'ðŸ§¿', 'ðŸŽ®', 'ðŸ•¹ï¸', 'ðŸŽ°', 'ðŸŽ²', 'ðŸ§©', 'ðŸŽ­', 'ðŸŽ¨', 'ðŸŽ¬', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸŽ¼', 'ðŸŽ¹', 'ðŸ¥', 'ðŸŽ·', 'ðŸŽº', 'ðŸŽ¸', 'ðŸª•', 'ðŸŽ»', 'ðŸ“±', 'ðŸ’»', 'âŒ¨ï¸', 'ðŸ–¥ï¸', 'ðŸ–¨ï¸', 'ðŸ–±ï¸', 'ðŸ’¾', 'ðŸ’¿', 'ðŸ“€', 'ðŸ“·', 'ðŸ“¹', 'ðŸŽ¥', 'ðŸ“ž', 'â˜Žï¸', 'ðŸ“º', 'ðŸ“»', 'ðŸŽ™ï¸', 'â°', 'âŒš', 'ðŸ’°', 'ðŸ’µ', 'ðŸ’´', 'ðŸ’¶', 'ðŸ’·', 'ðŸ’Ž', 'ðŸ”‘', 'ðŸ—ï¸']
        },
        nature: {
            icon: 'ðŸŒ¸',
            name: 'DoÄŸa',
            emojis: ['ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ¯', 'ðŸ¦', 'ðŸ®', 'ðŸ·', 'ðŸ¸', 'ðŸµ', 'ðŸ”', 'ðŸ§', 'ðŸ¦', 'ðŸ¤', 'ðŸ¦†', 'ðŸ¦…', 'ðŸ¦‰', 'ðŸ¦‡', 'ðŸº', 'ðŸ—', 'ðŸ´', 'ðŸ¦„', 'ðŸ', 'ðŸ›', 'ðŸ¦‹', 'ðŸŒ', 'ðŸž', 'ðŸœ', 'ðŸŒ¸', 'ðŸŒº', 'ðŸŒ¹', 'ðŸŒ·', 'ðŸŒ»', 'ðŸŒ¼', 'ðŸ€', 'ðŸŒ¿', 'ðŸŒ´', 'ðŸŒµ', 'ðŸŒ²', 'ðŸŒ³', 'â˜€ï¸', 'ðŸŒ™', 'â­', 'ðŸŒˆ', 'â˜ï¸', 'âš¡', 'â„ï¸', 'ðŸ”¥', 'ðŸ’§', 'ðŸŒŠ']
        },
        food: {
            icon: 'ðŸ•',
            name: 'Yiyecek',
            emojis: ['ðŸŽ', 'ðŸ', 'ðŸŠ', 'ðŸ‹', 'ðŸŒ', 'ðŸ‰', 'ðŸ‡', 'ðŸ“', 'ðŸ«', 'ðŸˆ', 'ðŸ’', 'ðŸ‘', 'ðŸ¥­', 'ðŸ', 'ðŸ¥¥', 'ðŸ¥', 'ðŸ…', 'ðŸ¥‘', 'ðŸ¥¦', 'ðŸ¥¬', 'ðŸ¥’', 'ðŸŒ¶ï¸', 'ðŸ«‘', 'ðŸŒ½', 'ðŸ¥•', 'ðŸ§„', 'ðŸ§…', 'ðŸ¥”', 'ðŸ ', 'ðŸ¥', 'ðŸ¥¯', 'ðŸž', 'ðŸ¥–', 'ðŸ¥¨', 'ðŸ§€', 'ðŸ¥š', 'ðŸ³', 'ðŸ§ˆ', 'ðŸ¥ž', 'ðŸ§‡', 'ðŸ¥“', 'ðŸ¥©', 'ðŸ—', 'ðŸ–', 'ðŸŒ­', 'ðŸ”', 'ðŸŸ', 'ðŸ•', 'ðŸ«“', 'ðŸ¥ª', 'ðŸ¥™', 'ðŸ§†', 'ðŸŒ®', 'ðŸŒ¯', 'ðŸ«”', 'ðŸ¥—', 'ðŸ¥˜', 'ðŸ«•', 'ðŸ', 'ðŸœ', 'ðŸ²', 'ðŸ›', 'ðŸ£', 'ðŸ±', 'ðŸ¥Ÿ', 'ðŸ¤', 'ðŸ™', 'ðŸš', 'ðŸ˜', 'ðŸ¥', 'ðŸ¥ ', 'ðŸ¥®', 'ðŸ¢', 'ðŸ¡', 'ðŸ§', 'ðŸ¨', 'ðŸ¦', 'ðŸ¥§', 'ðŸ§', 'ðŸ°', 'ðŸŽ‚', 'ðŸ®', 'ðŸ­', 'ðŸ¬', 'ðŸ«', 'ðŸ¿', 'ðŸ©', 'ðŸª', 'â˜•', 'ðŸµ', 'ðŸ§ƒ', 'ðŸ¥¤', 'ðŸ§‹', 'ðŸ¶', 'ðŸº', 'ðŸ»', 'ðŸ¥‚', 'ðŸ·', 'ðŸ¥ƒ', 'ðŸ¸', 'ðŸ¹', 'ðŸ§‰']
        },
        symbols: {
            icon: 'ðŸ’¯',
            name: 'Semboller',
            emojis: ['ðŸ’¯', 'âœ…', 'âŒ', 'â“', 'â—', 'ðŸ’¢', 'ðŸ’¥', 'ðŸ’«', 'ðŸ’¦', 'ðŸ’¨', 'ðŸ•³ï¸', 'ðŸ’¬', 'ðŸ‘ï¸â€ðŸ—¨ï¸', 'ðŸ—¨ï¸', 'ðŸ—¯ï¸', 'ðŸ’­', 'ðŸ’¤', 'ðŸ”´', 'ðŸŸ ', 'ðŸŸ¡', 'ðŸŸ¢', 'ðŸ”µ', 'ðŸŸ£', 'ðŸŸ¤', 'âš«', 'âšª', 'ðŸŸ¥', 'ðŸŸ§', 'ðŸŸ¨', 'ðŸŸ©', 'ðŸŸ¦', 'ðŸŸª', 'ðŸŸ«', 'â¬›', 'â¬œ', 'â—¼ï¸', 'â—»ï¸', 'â—¾', 'â—½', 'â–ªï¸', 'â–«ï¸', 'ðŸ”¶', 'ðŸ”·', 'ðŸ”¸', 'ðŸ”¹', 'ðŸ”º', 'ðŸ”»', 'ðŸ’ ', 'ðŸ”˜', 'ðŸ”³', 'ðŸ”²', 'ðŸ', 'ðŸš©', 'ðŸŽŒ', 'ðŸ´', 'ðŸ³ï¸', 'ðŸ³ï¸â€ðŸŒˆ', 'ðŸ³ï¸â€âš§ï¸', 'ðŸ´â€â˜ ï¸']
        }
    };

    // Stickers - Expanded collection
    const stickers = [
        // Happy / Positive
        { id: 's1', name: 'Mutlu', url: 'https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif' },
        { id: 's2', name: 'Thumbs Up', url: 'https://media.giphy.com/media/111ebonMs90YLu/giphy.gif' },
        { id: 's3', name: 'Kalp', url: 'https://media.giphy.com/media/26BRv0ThflsHCqDrG/giphy.gif' },
        { id: 's4', name: 'Kutlama', url: 'https://media.giphy.com/media/g9582DNuQppxC/giphy.gif' },
        { id: 's5', name: 'AlkÄ±ÅŸ', url: 'https://media.giphy.com/media/l0MYJnJQ4EiYLxvQ4/giphy.gif' },
        { id: 's6', name: 'Wow', url: 'https://media.giphy.com/media/udmx3pgdiD7tm/giphy.gif' },
        // Fun
        { id: 's7', name: 'LOL', url: 'https://media.giphy.com/media/10JhviFuU2gWD6/giphy.gif' },
        { id: 's8', name: 'TeÅŸekkÃ¼r', url: 'https://media.giphy.com/media/osjgQPWRx3cac/giphy.gif' },
        { id: 's9', name: 'Dans', url: 'https://media.giphy.com/media/l0MYGb1LuZ3n7dRnO/giphy.gif' },
        { id: 's10', name: 'Cool', url: 'https://media.giphy.com/media/62PP2yEIAZF6g/giphy.gif' },
        { id: 's11', name: 'ÃœzgÃ¼n', url: 'https://media.giphy.com/media/OPU6wzx8JrHna/giphy.gif' },
        { id: 's12', name: 'AÅŸk', url: 'https://media.giphy.com/media/l4pTdcifPZLpDjL1e/giphy.gif' },
        // More emotions
        { id: 's13', name: 'Hi', url: 'https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/giphy.gif' },
        { id: 's14', name: 'Evet!', url: 'https://media.giphy.com/media/l2JJKs3I69qfaQleE/giphy.gif' },
        { id: 's15', name: 'HayÄ±r', url: 'https://media.giphy.com/media/3o7TKwmnDgQb5jemjK/giphy.gif' },
        { id: 's16', name: 'GÃ¼zel', url: 'https://media.giphy.com/media/8VrtCswiLDNnO/giphy.gif' },
        { id: 's17', name: 'AÄŸlÄ±yor', url: 'https://media.giphy.com/media/d2lcHJTG5Tscg/giphy.gif' },
        { id: 's18', name: 'KorkmuÅŸ', url: 'https://media.giphy.com/media/14ut8PhnIwzros/giphy.gif' },
        // Reactions
        { id: 's19', name: 'ÅžaÅŸkÄ±n', url: 'https://media.giphy.com/media/ukGm72ZLZvYfS/giphy.gif' },
        { id: 's20', name: 'HeyecanlÄ±', url: 'https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif' },
        { id: 's21', name: 'DÃ¼ÅŸÃ¼nÃ¼yor', url: 'https://media.giphy.com/media/a5viI92PAF89q/giphy.gif' },
        { id: 's22', name: 'Uykulu', url: 'https://media.giphy.com/media/xT8qBvH1pAhtfSx52U/giphy.gif' },
        { id: 's23', name: 'KÄ±zgÄ±n', url: 'https://media.giphy.com/media/l1J9u3TZfpmeDLkD6/giphy.gif' },
        { id: 's24', name: 'Parti', url: 'https://media.giphy.com/media/l0MYJnJQ4EiYLxvQ4/giphy.gif' },
    ];

    // Favorite emojis (stored in state, would persist to localStorage in real app)
    const [favoriteEmojis, setFavoriteEmojis] = useState(['ðŸ˜€', 'â¤ï¸', 'ðŸ‘', 'ðŸŽ‰', 'ðŸ”¥', 'ðŸ˜‚', 'âœ…', 'ðŸ’¯', 'ðŸ˜', 'ðŸ™']);

    // Mock all users for search
    const allUsers = [
        { id: 'u1', name: 'Emre Ã–ztÃ¼rk', username: 'emreoz', avatar: 'EÃ–', online: true },
        { id: 'u2', name: 'Selin Aksoy', username: 'selinaksoy', avatar: 'SA', online: false },
        { id: 'u3', name: 'Burak Åžahin', username: 'buraksahin', avatar: 'BÅž', online: true },
        { id: 'u4', name: 'Elif YÄ±ldÄ±rÄ±m', username: 'elifyildirim', avatar: 'EY', online: true },
        { id: 'u5', name: 'OÄŸuz Han', username: 'oguzhan', avatar: 'OH', online: false },
    ];

    // Get current theme colors
    const currentTheme = COLOR_THEMES.find(t => t.id === selectedColorTheme) || COLOR_THEMES[0];
    const currentWallpaper = WALLPAPERS.find(w => w.id === selectedWallpaper) || WALLPAPERS[0];

    // Initialize mock messages
    useEffect(() => {
        const mockMessages = {
            'f1': [
                { id: 1, content: 'Selam!', senderId: 'f1', time: '10:30', isMe: false },
                { id: 2, content: 'Selam, nasÄ±lsÄ±n?', senderId: 'me', time: '10:31', isMe: true },
                { id: 3, content: 'Ä°yiyim, sen?', senderId: 'f1', time: '10:32', isMe: false },
                { id: 4, content: 'Merhaba!', senderId: 'f1', time: '10:35', isMe: false },
            ],
            'f2': [
                { id: 1, content: 'Proje nasÄ±l gidiyor?', senderId: 'f2', time: '09:00', isMe: false },
            ],
            'f4': [
                { id: 1, content: 'YardÄ±mÄ±n iÃ§in teÅŸekkÃ¼rler!', senderId: 'me', time: '14:20', isMe: true },
                { id: 2, content: 'TeÅŸekkÃ¼rler ðŸ˜Š', senderId: 'f4', time: '14:25', isMe: false },
            ]
        };
        setMessages(mockMessages);

        // Load saved preferences
        const savedTheme = localStorage.getItem('chatColorTheme');
        const savedWallpaper = localStorage.getItem('chatWallpaper');
        const savedDarkMode = localStorage.getItem('chatDarkMode');

        if (savedTheme) setSelectedColorTheme(savedTheme);
        if (savedWallpaper) setSelectedWallpaper(savedWallpaper);
        if (savedDarkMode !== null) setIsDarkMode(savedDarkMode === 'true');
    }, []);

    // Save preferences
    useEffect(() => {
        localStorage.setItem('chatColorTheme', selectedColorTheme);
        localStorage.setItem('chatWallpaper', selectedWallpaper);
        localStorage.setItem('chatDarkMode', isDarkMode.toString());
    }, [selectedColorTheme, selectedWallpaper, isDarkMode]);

    // Socket connection
    useEffect(() => {
        if (!user) return;

        const socketUrl = API_URL || window.location.origin;
        const newSocket = io(socketUrl, {
            transports: ['websocket', 'polling']
        });

        newSocket.on('connect', () => setIsConnected(true));
        newSocket.on('disconnect', () => setIsConnected(false));

        setSocket(newSocket);
        return () => newSocket.close();
    }, [user]);

    // Scroll to bottom
    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages, selectedFriend]);



    // Search users
    const handleUserSearch = (query) => {
        setUserSearchQuery(query);
        if (query.length > 0) {
            const results = allUsers.filter(u =>
                u.name.toLowerCase().includes(query.toLowerCase()) ||
                u.username.toLowerCase().includes(query.toLowerCase())
            );
            setSearchResults(results);
        } else {
            setSearchResults([]);
        }
    };

    // Send message request
    const sendMessageRequest = (user) => {
        setPendingRequests([...pendingRequests, user.id]);
        setTimeout(() => {
            alert(`${user.name} kiÅŸisine mesaj isteÄŸi gÃ¶nderildi!`);
        }, 500);
    };

    // Send message
    const handleSendMessage = (e) => {
        e.preventDefault();
        if (!inputMessage.trim() || !selectedFriend) return;

        const newMessage = {
            id: Date.now(),
            content: inputMessage.trim(),
            senderId: 'me',
            time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
            isMe: true
        };

        setMessages(prev => ({
            ...prev,
            [selectedFriend.id]: [...(prev[selectedFriend.id] || []), newMessage]
        }));

        setFriends(prev => prev.map(f =>
            f.id === selectedFriend.id
                ? { ...f, lastMessage: inputMessage.trim(), lastMessageTime: new Date(), unread: 0 }
                : f
        ));

        setInputMessage('');
        setShowEmojiPicker(false);

        if (socket) {
            socket.emit('send_message', {
                sender_id: user?.id,
                sender_name: user?.full_name,
                content: inputMessage.trim(),
                receiver_id: selectedFriend.id
            });
        }
    };

    // Add emoji to message
    const addEmoji = (emoji) => {
        setInputMessage(prev => prev + emoji);
    };

    // Send sticker
    const sendSticker = (sticker) => {
        if (!selectedFriend) return;

        const newMessage = {
            id: Date.now(),
            content: '',
            sticker: sticker.url,
            stickerName: sticker.name,
            senderId: 'me',
            time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
            isMe: true
        };

        setMessages(prev => ({
            ...prev,
            [selectedFriend.id]: [...(prev[selectedFriend.id] || []), newMessage]
        }));

        setFriends(prev => prev.map(f =>
            f.id === selectedFriend.id
                ? { ...f, lastMessage: `ðŸŽ­ ${sticker.name}`, lastMessageTime: new Date() }
                : f
        ));

        setShowEmojiPicker(false);
    };

    // Handle file upload
    const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file || !selectedFriend) return;

        const isImage = file.type.startsWith('image/');
        const reader = new FileReader();

        reader.onload = (event) => {
            const newMessage = {
                id: Date.now(),
                content: isImage ? '' : `ðŸ“Ž ${file.name}`,
                image: isImage ? event.target.result : null,
                fileName: !isImage ? file.name : null,
                senderId: 'me',
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                isMe: true
            };

            setMessages(prev => ({
                ...prev,
                [selectedFriend.id]: [...(prev[selectedFriend.id] || []), newMessage]
            }));

            setFriends(prev => prev.map(f =>
                f.id === selectedFriend.id
                    ? { ...f, lastMessage: isImage ? 'ðŸ“· FotoÄŸraf' : `ðŸ“Ž ${file.name}`, lastMessageTime: new Date() }
                    : f
            ));
        };

        reader.readAsDataURL(file);
        e.target.value = ''; // Reset input
    };

    // Start a call
    const startCall = (type) => {
        if (!selectedFriend) return;
        setCallType(type);
        setCallStatus('calling');
        setCallDuration(0);
        setShowCallModal(true);

        // Simulate call connection after 2 seconds
        setTimeout(() => {
            setCallStatus('connected');
            // Start duration timer
            const timer = setInterval(() => {
                setCallDuration(prev => prev + 1);
            }, 1000);
            // Store timer to clear later
            window.callTimer = timer;
        }, 2000);
    };

    // Recent Calls
    const [recentCalls, setRecentCalls] = useState([
        { id: 'c1', userId: 'f1', name: 'Ali YÄ±lmaz', avatar: 'AY', type: 'voice', duration: '05:23', time: new Date(Date.now() - 3600000), status: 'incoming' },
        { id: 'c2', userId: 'f2', name: 'Zeynep Demir', avatar: 'ZD', type: 'video', duration: '12:45', time: new Date(Date.now() - 86400000), status: 'outgoing' },
    ]);

    // End call
    const endCall = () => {
        if (window.callTimer) {
            clearInterval(window.callTimer);
        }

        // Create call log message
        if (selectedFriend) {
            const durationFormatted = formatDuration(callDuration);
            const callLogMessage = {
                id: Date.now(),
                content: `${callType === 'video' ? 'GÃ¶rÃ¼ntÃ¼lÃ¼ Arama' : 'Sesli Arama'} - ${durationFormatted}`,
                type: 'call-log',
                callType: callType,
                duration: durationFormatted,
                senderId: 'me',
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                isMe: true
            };

            setMessages(prev => ({
                ...prev,
                [selectedFriend.id]: [...(prev[selectedFriend.id] || []), callLogMessage]
            }));

            // Add to recent calls
            const newCall = {
                id: Date.now(),
                userId: selectedFriend.id,
                name: selectedFriend.name,
                avatar: selectedFriend.avatar,
                type: callType,
                duration: durationFormatted,
                time: new Date(),
                status: 'outgoing'
            };
            setRecentCalls(prev => [newCall, ...prev]);

            // Update last message in friends list
            setFriends(prev => prev.map(f =>
                f.id === selectedFriend.id
                    ? { ...f, lastMessage: `${callType === 'video' ? 'ðŸ“¹' : 'ðŸ“ž'} Arama (${durationFormatted})`, lastMessageTime: new Date() }
                    : f
            ));
        }

        setCallStatus('ended');
        setTimeout(() => {
            setShowCallModal(false);
            setCallStatus('calling');
            setCallDuration(0);
        }, 1000);
    };

    // Filter Logic
    const filteredFriends = filter === 'calls'
        ? [] // We handle calls rendering separately
        : friends.filter(f => {
            const matchesFilter = filter === 'all' ||
                (filter === 'online' && f.online) ||
                (filter === 'favorites' && f.isFavorite);
            const matchesSearch = f.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                f.username.toLowerCase().includes(searchQuery.toLowerCase());
            return matchesFilter && matchesSearch;
        });

    // Format call duration
    const formatDuration = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    };

    // Toggle favorite
    const toggleFavorite = (friendId) => {
        setFriends(prev => prev.map(f =>
            f.id === friendId ? { ...f, isFavorite: !f.isFavorite } : f
        ));
    };

    // Toggle block user
    const toggleBlock = (friendId) => {
        console.log('ðŸš« toggleBlock called with:', friendId);
        const isBlocked = blockedUsers.includes(friendId);
        if (isBlocked) {
            setBlockedUsers(prev => prev.filter(id => id !== friendId));
            console.log('âœ… User unblocked');
        } else {
            setBlockedUsers(prev => [...prev, friendId]);
            console.log('ðŸš« User blocked');
        }
        setShowOptionsMenu(false);
    };

    // Toggle mute chat
    const toggleMuteChat = (friendId) => {
        console.log('ðŸ”• toggleMuteChat called with:', friendId);
        const isMuted = mutedChats.includes(friendId);
        if (isMuted) {
            setMutedChats(prev => prev.filter(id => id !== friendId));
            console.log('ðŸ”” Notifications enabled');
        } else {
            setMutedChats(prev => [...prev, friendId]);
            console.log('ðŸ”• Notifications muted');
        }
        setShowOptionsMenu(false);
    };

    // Delete chat request
    const deleteChat = (friendId) => {
        setConfirmModal({
            isOpen: true,
            type: 'delete',
            title: 'Sohbeti Sil',
            message: 'Bu sohbeti silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.',
            data: friendId
        });
        setShowOptionsMenu(false);
    };

    // Remove chat request (leave)
    const removeChat = (friendId) => {
        setConfirmModal({
            isOpen: true,
            type: 'leave',
            title: 'Sohbetten AyrÄ±l',
            message: 'Bu kiÅŸiyi sohbet listenizden Ã§Ä±karmak istediÄŸinizden emin misiniz?',
            data: friendId
        });
        setShowOptionsMenu(false);
    };

    // Execute confirmed action
    const handleConfirmAction = () => {
        const { type, data: friendId } = confirmModal;

        if (type === 'delete') {
            // Delete chat AND remove from list
            setMessages(prev => {
                const newMessages = { ...prev };
                delete newMessages[friendId];
                return newMessages;
            });
            setFriends(prev => prev.filter(f => f.id !== friendId)); // Remove from list
            if (selectedFriend?.id === friendId) {
                setSelectedFriend(null); // Deselect if currently open
            }
            console.log('ðŸ—‘ï¸ Chat deleted and removed via modal');
        } else if (type === 'leave') {
            setFriends(prev => prev.filter(f => f.id !== friendId));
            setMessages(prev => {
                const newMessages = { ...prev };
                delete newMessages[friendId];
                return newMessages;
            });
            if (selectedFriend?.id === friendId) {
                setSelectedFriend(null);
            }
            console.log('ðŸšª Chat removed via modal');
        }

        setConfirmModal({ isOpen: false, type: null, title: '', message: '', data: null });
    };

    // Get time ago text
    const getTimeAgo = (date) => {
        const now = new Date();
        const diff = now - new Date(date);
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Åžimdi';
        if (minutes < 60) return `${minutes}d`;
        if (hours < 24) return `${hours}s`;
        return `${days}g`;
    };

    // Get wallpaper style
    // Get wallpaper style - UPDATED to return transparent if image is handled by container
    const getWallpaperStyle = () => {
        if (currentWallpaper.type === 'image') {
            // If it's an image, the container handles it so orbs show on top.
            // We return transparent here so we don't cover the orbs.
            return { background: 'transparent' };
        }
        // For gradients/colors, we apply them here
        return { background: currentWallpaper.value };
    };

    // Dynamic styles
    // Dynamic styles
    const containerStyle = {
        '--theme-primary': currentTheme.primary,
        '--theme-secondary': currentTheme.secondary,
        ...(currentWallpaper.type === 'image' ? {
            backgroundImage: `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url(${currentWallpaper.value})`,
            backgroundSize: 'cover',
            backgroundPosition: 'center',
            backgroundAttachment: 'fixed'
        } : {})
    };

    if (!user) {
        return (
            <div className={`chat-login-prompt ${isDarkMode ? 'dark' : 'light'}`}>
                <MessageCircle size={64} />
                <h2>GiriÅŸ YapÄ±n</h2>
                <p>Sohbetlere eriÅŸmek iÃ§in lÃ¼tfen giriÅŸ yapÄ±n</p>
            </div>
        );
    }

    return (
        <div
            className={`modern-chat-container ${isDarkMode ? 'dark' : 'light'}`}
            style={containerStyle}
        >
            {/* Animated Background */}
            <div className="animated-bg">
                <div className="bg-orb bg-orb-1" style={{ background: currentTheme.primary }}></div>
                <div className="bg-orb bg-orb-2" style={{ background: currentTheme.secondary }}></div>
                <div className="bg-orb bg-orb-3" style={{ background: currentTheme.primary }}></div>
            </div>

            {/* Sidebar */}
            <div className="chat-sidebar-modern">
                <div className="sidebar-header">
                    <h1>Sohbetler</h1>
                    <div className="header-actions">
                        <button
                            className="icon-button"
                            onClick={() => setIsDarkMode(!isDarkMode)}
                            title={isDarkMode ? 'GÃ¼ndÃ¼z Modu' : 'Gece Modu'}
                        >
                            {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}
                        </button>
                        <button
                            className="icon-button"
                            onClick={() => setShowSettings(true)}
                            title="Ã–zelleÅŸtir"
                        >
                            <Palette size={20} />
                        </button>
                        <button
                            className="new-message-btn"
                            onClick={() => setShowNewMessageModal(true)}
                            title="Yeni Mesaj"
                        >
                            <UserPlus size={20} />
                        </button>
                    </div>
                </div>

                {/* Search */}
                <div className="sidebar-search">
                    <Search size={18} className="search-icon" />
                    <input
                        type="text"
                        placeholder={filter === 'calls' ? "Arama geÃ§miÅŸinde ara..." : "Sohbet ara..."}
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>

                {/* Filter Tabs */}
                <div className="filter-tabs">
                    <button
                        className={`filter-tab ${filter === 'all' ? 'active' : ''}`}
                        onClick={() => setFilter('all')}
                    >
                        TÃ¼mÃ¼
                    </button>
                    <button
                        className={`filter-tab ${filter === 'online' ? 'active' : ''}`}
                        onClick={() => setFilter('online')}
                    >
                        <Circle size={8} fill="#22c55e" className="online-dot" />
                        Ã‡evrimiÃ§i
                    </button>
                    <button
                        className={`filter-tab ${filter === 'favorites' ? 'active' : ''}`}
                        onClick={() => setFilter('favorites')}
                    >
                        <Star size={14} fill={filter === 'favorites' ? 'currentColor' : 'none'} />
                    </button>
                    <button
                        className={`filter-tab ${filter === 'calls' ? 'active' : ''}`}
                        onClick={() => setFilter('calls')}
                    >
                        <Phone size={14} />
                    </button>
                </div>

                {/* Friends List */}
                <div className="friends-list">
                    {filter === 'calls' ? (
                        recentCalls.length === 0 ? (
                            <div className="no-friends">
                                <Phone size={40} />
                                <p>Arama geÃ§miÅŸi boÅŸ</p>
                            </div>
                        ) : (
                            recentCalls.map(call => (
                                <div key={call.id} className="friend-card call-card">
                                    <div className="friend-avatar-wrapper">
                                        <div className="friend-avatar" style={{
                                            background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                        }}>{call.avatar}</div>
                                        <div className="call-type-indicator">
                                            {call.type === 'video' ? <Video size={12} /> : <Phone size={12} />}
                                        </div>
                                    </div>
                                    <div className="friend-details">
                                        <div className="friend-header">
                                            <span className="friend-name">{call.name}</span>
                                            <span className="message-time">{getTimeAgo(call.time)}</span>
                                        </div>
                                        <div className="friend-footer">
                                            <span className="last-message call-info">
                                                {call.status === 'incoming' ? <ArrowDownLeft size={14} color="#22c55e" /> : <ArrowUpRight size={14} color="#ef4444" />}
                                                <span style={{ marginLeft: 4 }}>{call.duration}</span>
                                            </span>
                                            <button className="call-again-btn" onClick={(e) => {
                                                e.stopPropagation();
                                                const friend = friends.find(f => f.id === call.userId);
                                                if (friend) {
                                                    setSelectedFriend(friend);
                                                    startCall(call.type);
                                                }
                                            }}>
                                                <Phone size={14} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )
                    ) : (
                        filteredFriends.length === 0 ? (
                            <div className="no-friends">
                                <Users size={40} />
                                <p>{filter === 'online' ? 'Ã‡evrimiÃ§i arkadaÅŸ yok' : 'Sohbet bulunamadÄ±'}</p>
                            </div>
                        ) : (
                            filteredFriends.map(friend => (
                                <div
                                    key={friend.id}
                                    className={`friend-card ${selectedFriend?.id === friend.id ? 'selected' : ''}`}
                                    onClick={() => {
                                        setSelectedFriend(friend);
                                        setFriends(prev => prev.map(f =>
                                            f.id === friend.id ? { ...f, unread: 0 } : f
                                        ));
                                    }}
                                >
                                    <div className="friend-avatar-wrapper">
                                        <div className="friend-avatar" style={{
                                            background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                        }}>{friend.avatar}</div>
                                        {friend.online && <div className="online-indicator" />}
                                    </div>
                                    <div className="friend-details">
                                        <div className="friend-header">
                                            <span className="friend-name">
                                                {friend.name}
                                                {mutedChats.includes(friend.id) && <span style={{ marginLeft: '6px', fontSize: '0.75rem' }} title="Bildirimler kapalÄ±">ðŸ”•</span>}
                                                {blockedUsers.includes(friend.id) && <span style={{ marginLeft: '6px', fontSize: '0.75rem' }} title="Engellendi">ðŸš«</span>}
                                            </span>
                                            <span className="message-time">{getTimeAgo(friend.lastMessageTime)}</span>
                                        </div>
                                        <div className="friend-footer">
                                            <span className="last-message">{friend.lastMessage}</span>
                                            {friend.unread > 0 && (
                                                <span className="unread-badge" style={{
                                                    background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                                }}>{friend.unread}</span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )
                    )}
                </div>
            </div>

            {/* Chat Window */}
            <div className="chat-window-modern" style={getWallpaperStyle()}>
                {!selectedFriend ? (
                    <div className="no-chat-selected">
                        <div className="no-chat-icon" style={{
                            background: `linear-gradient(135deg, ${currentTheme.primary}20, ${currentTheme.secondary}20)`,
                            color: currentTheme.primary
                        }}>
                            <MessageCircle size={80} />
                        </div>
                        <h2>Sohbet SeÃ§in</h2>
                        <p>MesajlaÅŸmaya baÅŸlamak iÃ§in bir sohbet seÃ§in</p>
                        <button
                            className="start-chat-btn"
                            onClick={() => setShowNewMessageModal(true)}
                            style={{
                                background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                            }}
                        >
                            <UserPlus size={20} />
                            Yeni Sohbet BaÅŸlat
                        </button>
                    </div>
                ) : (
                    <>
                        {/* Chat Header */}
                        <div className="chat-header-modern">
                            <button
                                className="back-btn mobile-only"
                                onClick={() => setSelectedFriend(null)}
                            >
                                <ArrowLeft size={24} />
                            </button>
                            <div className="chat-user-info">
                                <div className="friend-avatar-wrapper">
                                    <div className="friend-avatar" style={{
                                        background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                    }}>{selectedFriend.avatar}</div>
                                    {selectedFriend.online && <div className="online-indicator" />}
                                </div>
                                <div>
                                    <h3>
                                        {selectedFriend.name}
                                        {mutedChats.includes(selectedFriend.id) && <span style={{ marginLeft: '8px', fontSize: '0.8rem' }} title="Bildirimler kapalÄ±">ðŸ”•</span>}
                                        {blockedUsers.includes(selectedFriend.id) && <span style={{ marginLeft: '8px', fontSize: '0.8rem' }} title="Engellendi">ðŸš«</span>}
                                    </h3>
                                    <span className={`status ${selectedFriend.online ? 'online' : 'offline'}`}>
                                        {blockedUsers.includes(selectedFriend.id) ? 'Engellendi' : (selectedFriend.online ? 'Ã‡evrimiÃ§i' : 'Ã‡evrimdÄ±ÅŸÄ±')}
                                    </span>
                                </div>
                            </div>
                            <div className="chat-actions">
                                <button className="action-btn" onClick={() => startCall('voice')} title="Sesli Arama">
                                    <Phone size={20} />
                                </button>
                                <button className="action-btn" onClick={() => startCall('video')} title="GÃ¶rÃ¼ntÃ¼lÃ¼ Arama">
                                    <Video size={20} />
                                </button>
                                <button
                                    className="action-btn"
                                    onClick={() => toggleFavorite(selectedFriend.id)}
                                    title={selectedFriend.isFavorite ? 'Favorilerden Ã‡Ä±kar' : 'Favorilere Ekle'}
                                >
                                    <Star size={20} fill={selectedFriend.isFavorite ? 'currentColor' : 'none'} color={selectedFriend.isFavorite ? '#fbbf24' : 'currentColor'} />
                                </button>
                                <button
                                    className="action-btn"
                                    ref={optionsMenuRef}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        if (!showOptionsMenu) {
                                            const rect = e.currentTarget.getBoundingClientRect();
                                            setMenuPosition({
                                                top: rect.bottom + 8,
                                                left: rect.right - 220 // 220px width approx
                                            });
                                        }
                                        setShowOptionsMenu(!showOptionsMenu);
                                    }}
                                >
                                    <MoreVertical size={20} />
                                </button>
                                {showOptionsMenu && createPortal(
                                    <div
                                        className="options-menu-portal"
                                        style={{
                                            position: 'fixed',
                                            top: `${menuPosition.top}px`,
                                            left: `${menuPosition.left}px`,
                                            zIndex: 99999,
                                            minWidth: '220px',
                                            background: '#1e1e2e', // Solid background color
                                            border: '1px solid rgba(255, 255, 255, 0.15)',
                                            borderRadius: '12px',
                                            boxShadow: '0 10px 40px rgba(0, 0, 0, 0.6)',
                                            overflow: 'hidden',
                                            padding: '4px',
                                            animation: 'fadeIn 0.2s ease-out'
                                        }}
                                        onClick={(e) => e.stopPropagation()}
                                    >
                                        <button
                                            type="button"
                                            style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '12px',
                                                width: '100%',
                                                padding: '12px 16px',
                                                background: 'transparent',
                                                border: 'none',
                                                color: 'rgba(255, 255, 255, 0.9)',
                                                fontSize: '14px',
                                                cursor: 'pointer',
                                                textAlign: 'left',
                                                borderRadius: '8px',
                                                transition: 'all 0.2s'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.08)'}
                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                console.log('Mute button clicked!');
                                                toggleMuteChat(selectedFriend.id);
                                            }}
                                        >
                                            {mutedChats.includes(selectedFriend.id) ? <Bell size={18} /> : <BellOff size={18} />}
                                            <span>{mutedChats.includes(selectedFriend.id) ? 'Bildirimleri AÃ§' : 'Bildirimleri Kapat'}</span>
                                        </button>
                                        <button
                                            type="button"
                                            style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '12px',
                                                width: '100%',
                                                padding: '12px 16px',
                                                background: 'transparent',
                                                border: 'none',
                                                color: 'rgba(255, 255, 255, 0.9)',
                                                fontSize: '14px',
                                                cursor: 'pointer',
                                                textAlign: 'left',
                                                borderRadius: '8px',
                                                transition: 'all 0.2s'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.08)'}
                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                console.log('Block button clicked!');
                                                toggleBlock(selectedFriend.id);
                                            }}
                                        >
                                            <Ban size={18} />
                                            <span>{blockedUsers.includes(selectedFriend.id) ? 'Engeli KaldÄ±r' : 'Engelle'}</span>
                                        </button>
                                        <div style={{ height: '1px', background: 'rgba(255,255,255,0.1)', margin: '4px 0' }} />
                                        <button
                                            type="button"
                                            style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '12px',
                                                width: '100%',
                                                padding: '12px 16px',
                                                background: 'transparent',
                                                border: 'none',
                                                color: 'rgba(255, 255, 255, 0.9)',
                                                fontSize: '14px',
                                                cursor: 'pointer',
                                                textAlign: 'left',
                                                borderRadius: '8px',
                                                transition: 'all 0.2s'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.08)'}
                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                console.log('Delete button clicked!');
                                                deleteChat(selectedFriend.id);
                                            }}
                                        >
                                            <Trash2 size={18} />
                                            <span>Sohbeti Sil</span>
                                        </button>

                                    </div>,
                                    document.body
                                )}
                            </div>
                        </div>



                        {/* Messages */}
                        <div className="messages-container" onClick={() => setShowEmojiPicker(false)}>
                            {(messages[selectedFriend.id] || []).map(msg => {
                                if (msg.type === 'call-log') {
                                    return (
                                        <div key={msg.id} className="message-call-log">
                                            <div className="call-log-content">
                                                {msg.callType === 'video' ? <Video size={16} /> : <Phone size={16} />}
                                                <span>{msg.content}</span>
                                            </div>
                                            <span className="call-log-time">{msg.time}</span>
                                        </div>
                                    );
                                }
                                return (
                                    <div
                                        key={msg.id}
                                        className={`message-bubble ${msg.isMe ? 'sent' : 'received'} ${msg.image || msg.sticker ? 'has-image' : ''}`}
                                        style={!msg.image && !msg.sticker ? (msg.isMe ? {
                                            background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                        } : {
                                            background: `linear-gradient(135deg, ${currentTheme.primary}25, ${currentTheme.secondary}15)`,
                                            borderLeft: `3px solid ${currentTheme.primary}`
                                        }) : {}}
                                    >
                                        {msg.image && (
                                            <img src={msg.image} alt="FotoÄŸraf" className="message-image" />
                                        )}
                                        {msg.sticker && (
                                            <img src={msg.sticker} alt={msg.stickerName} className="message-sticker" />
                                        )}
                                        {msg.content && <p>{msg.content}</p>}
                                        <span className="message-time">{msg.time}</span>
                                    </div>
                                );
                            })}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Emoji & Sticker Picker */}
                        {showEmojiPicker && (
                            <div className="emoji-picker-full">
                                {/* Tabs */}
                                <div className="picker-tabs">
                                    <button
                                        className={`picker-tab ${emojiTab === 'emoji' ? 'active' : ''}`}
                                        onClick={() => setEmojiTab('emoji')}
                                    >
                                        ðŸ˜€ Emoji
                                    </button>
                                    <button
                                        className={`picker-tab ${emojiTab === 'sticker' ? 'active' : ''}`}
                                        onClick={() => setEmojiTab('sticker')}
                                    >
                                        ðŸŽ­ Ã‡Ä±kartma
                                    </button>
                                    <button
                                        className="close-picker"
                                        onClick={() => setShowEmojiPicker(false)}
                                    >
                                        <X size={18} />
                                    </button>
                                </div>

                                {emojiTab === 'emoji' ? (
                                    <>
                                        {/* Category Buttons with Favorites */}
                                        <div className="emoji-categories">
                                            <button
                                                className={`category-btn ${emojiCategory === 'favorites' ? 'active' : ''}`}
                                                onClick={() => setEmojiCategory('favorites')}
                                                title="Favoriler"
                                            >
                                                â­
                                            </button>
                                            {Object.entries(emojiCategories).map(([key, cat]) => (
                                                <button
                                                    key={key}
                                                    className={`category-btn ${emojiCategory === key ? 'active' : ''}`}
                                                    onClick={() => setEmojiCategory(key)}
                                                    title={cat.name}
                                                >
                                                    {cat.icon}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Emoji Grid */}
                                        <div className="emoji-grid-large">
                                            {emojiCategory === 'favorites' ? (
                                                favoriteEmojis.length > 0 ? (
                                                    favoriteEmojis.map((emoji, index) => (
                                                        <button
                                                            key={index}
                                                            className="emoji-btn"
                                                            onClick={() => addEmoji(emoji)}
                                                            onContextMenu={(e) => {
                                                                e.preventDefault();
                                                                setFavoriteEmojis(prev => prev.filter(e => e !== emoji));
                                                            }}
                                                            title="Sol tÄ±k: Ekle | SaÄŸ tÄ±k: Favorilerden Ã§Ä±kar"
                                                        >
                                                            {emoji}
                                                        </button>
                                                    ))
                                                ) : (
                                                    <div className="no-favorites">
                                                        <span>HenÃ¼z favori emoji yok</span>
                                                        <small>Emoji Ã¼zerine Ã§ift tÄ±klayarak favorilere ekle</small>
                                                    </div>
                                                )
                                            ) : (
                                                emojiCategories[emojiCategory]?.emojis.map((emoji, index) => (
                                                    <button
                                                        key={index}
                                                        className={`emoji-btn ${favoriteEmojis.includes(emoji) ? 'is-favorite' : ''}`}
                                                        onClick={() => addEmoji(emoji)}
                                                        onDoubleClick={() => {
                                                            if (!favoriteEmojis.includes(emoji)) {
                                                                setFavoriteEmojis(prev => [...prev, emoji]);
                                                            }
                                                        }}
                                                        title="Tek tÄ±k: Ekle | Ã‡ift tÄ±k: Favorilere ekle"
                                                    >
                                                        {emoji}
                                                    </button>
                                                ))
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    /* Sticker Grid - Larger */
                                    <div className="sticker-grid-large">
                                        {stickers.map(sticker => (
                                            <button
                                                key={sticker.id}
                                                className="sticker-btn"
                                                onClick={() => sendSticker(sticker)}
                                                title={sticker.name}
                                            >
                                                <img src={sticker.url} alt={sticker.name} />
                                                <span className="sticker-name">{sticker.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Input */}
                        {blockedUsers.includes(selectedFriend.id) ? (
                            <div className="message-input-container" style={{ justifyContent: 'center' }}>
                                <span style={{ color: 'rgba(255,255,255,0.5)', fontSize: '0.9rem' }}>
                                    ðŸš« Bu kullanÄ±cÄ±yÄ± engellediniz. Mesaj gÃ¶nderemezsiniz.
                                </span>
                            </div>
                        ) : (
                            <form className="message-input-container" onSubmit={handleSendMessage}>
                                {/* Hidden file input */}
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileUpload}
                                    accept="image/*,.pdf,.doc,.docx,.txt"
                                    style={{ display: 'none' }}
                                />
                                <button
                                    type="button"
                                    className="input-action-btn"
                                    onClick={() => fileInputRef.current?.click()}
                                    title="Dosya/FotoÄŸraf Ekle"
                                >
                                    <Paperclip size={20} />
                                </button>
                                <input
                                    type="text"
                                    placeholder="Mesaj yazÄ±n..."
                                    value={inputMessage}
                                    onChange={(e) => setInputMessage(e.target.value)}
                                />
                                <button
                                    type="button"
                                    className={`input-action-btn ${showEmojiPicker ? 'active' : ''}`}
                                    onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                    title="Emoji Ekle"
                                >
                                    <Smile size={20} />
                                </button>
                                <button
                                    type="submit"
                                    className="send-message-btn"
                                    disabled={!inputMessage.trim()}
                                    style={{
                                        background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                    }}
                                >
                                    <Send size={20} />
                                </button>
                            </form>
                        )}
                    </>
                )}
            </div>

            {/* Settings Modal */}
            {
                showSettings && (
                    <div className="modal-overlay" onClick={() => setShowSettings(false)}>
                        <div className="settings-modal" onClick={e => e.stopPropagation()}>
                            <div className="modal-header">
                                <h2>Ã–zelleÅŸtir</h2>
                                <button className="close-btn" onClick={() => setShowSettings(false)}>
                                    <X size={24} />
                                </button>
                            </div>

                            {/* Theme Toggle */}
                            <div className="settings-section">
                                <h3>Tema</h3>
                                <div className="theme-toggle">
                                    <button
                                        className={`theme-option ${!isDarkMode ? 'active' : ''}`}
                                        onClick={() => setIsDarkMode(false)}
                                    >
                                        <Sun size={24} />
                                        <span>GÃ¼ndÃ¼z</span>
                                    </button>
                                    <button
                                        className={`theme-option ${isDarkMode ? 'active' : ''}`}
                                        onClick={() => setIsDarkMode(true)}
                                    >
                                        <Moon size={24} />
                                        <span>Gece</span>
                                    </button>
                                </div>
                            </div>

                            {/* Color Theme */}
                            <div className="settings-section">
                                <h3>Mesaj Rengi</h3>
                                <div className="color-options">
                                    {COLOR_THEMES.map(theme => (
                                        <button
                                            key={theme.id}
                                            className={`color-option ${selectedColorTheme === theme.id ? 'active' : ''}`}
                                            style={{ background: `linear-gradient(135deg, ${theme.primary}, ${theme.secondary})` }}
                                            onClick={() => setSelectedColorTheme(theme.id)}
                                            title={theme.name}
                                        >
                                            {selectedColorTheme === theme.id && <Check size={16} />}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Wallpaper */}
                            <div className="settings-section">
                                <h3>Duvar KaÄŸÄ±dÄ±</h3>
                                <div className="wallpaper-options">
                                    {WALLPAPERS.map(wp => (
                                        <button
                                            key={wp.id}
                                            className={`wallpaper-option ${selectedWallpaper === wp.id ? 'active' : ''}`}
                                            style={wp.type === 'image'
                                                ? { backgroundImage: `url(${wp.value})`, backgroundSize: 'cover', backgroundPosition: 'center' }
                                                : { background: wp.value }
                                            }
                                            onClick={() => setSelectedWallpaper(wp.id)}
                                        >
                                            <span>{wp.name}</span>
                                            {selectedWallpaper === wp.id && <Check size={16} />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }

            {/* New Message Modal */}
            {
                showNewMessageModal && (
                    <div className="modal-overlay" onClick={() => setShowNewMessageModal(false)}>
                        <div className="new-message-modal" onClick={e => e.stopPropagation()}>
                            <div className="modal-header">
                                <h2>Yeni Mesaj</h2>
                                <button className="close-btn" onClick={() => setShowNewMessageModal(false)}>
                                    <X size={24} />
                                </button>
                            </div>

                            <div className="modal-search">
                                <Search size={18} />
                                <input
                                    type="text"
                                    placeholder="KullanÄ±cÄ± adÄ± ile ara..."
                                    value={userSearchQuery}
                                    onChange={(e) => handleUserSearch(e.target.value)}
                                    autoFocus
                                />
                            </div>

                            <div className="search-results">
                                {userSearchQuery.length === 0 ? (
                                    <div className="search-hint">
                                        <Search size={40} />
                                        <p>Mesaj gÃ¶ndermek istediÄŸiniz kiÅŸinin kullanÄ±cÄ± adÄ±nÄ± yazÄ±n</p>
                                    </div>
                                ) : searchResults.length === 0 ? (
                                    <div className="no-results">
                                        <p>"{userSearchQuery}" iÃ§in sonuÃ§ bulunamadÄ±</p>
                                    </div>
                                ) : (
                                    searchResults.map(user => (
                                        <div key={user.id} className="search-result-item">
                                            <div className="friend-avatar-wrapper">
                                                <div className="friend-avatar" style={{
                                                    background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                                }}>{user.avatar}</div>
                                                {user.online && <div className="online-indicator" />}
                                            </div>
                                            <div className="user-info">
                                                <span className="user-name">{user.name}</span>
                                                <span className="user-username">@{user.username}</span>
                                            </div>
                                            <button
                                                className={`request-btn ${pendingRequests.includes(user.id) ? 'sent' : ''}`}
                                                onClick={() => sendMessageRequest(user)}
                                                disabled={pendingRequests.includes(user.id)}
                                                style={!pendingRequests.includes(user.id) ? {
                                                    background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                                } : {}}
                                            >
                                                {pendingRequests.includes(user.id) ? (
                                                    <>
                                                        <Check size={16} />
                                                        GÃ¶nderildi
                                                    </>
                                                ) : (
                                                    <>
                                                        <Send size={16} />
                                                        Ä°stek GÃ¶nder
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                )
            }

            {/* Call Modal */}
            {
                showCallModal && (
                    <div className="call-modal-overlay">
                        <div className="call-modal">
                            <div className="call-header">
                                <div className="call-status">
                                    {callStatus === 'calling' ? 'AranÄ±yor...' : callStatus === 'ended' ? 'Arama SonlandÄ±' : 'BaÄŸlandÄ±'}
                                </div>
                                {callStatus === 'connected' && (
                                    <div className="call-duration">{formatDuration(callDuration)}</div>
                                )}
                            </div>

                            <div className="call-user-info">
                                {callType === 'video' ? (
                                    <div className="call-video-container">
                                        <video
                                            ref={localVideoRef}
                                            autoPlay
                                            muted
                                            playsInline
                                            className="call-video"
                                        />
                                        <div className="call-overlay-name">{selectedFriend?.name}</div>
                                    </div>
                                ) : (
                                    <>
                                        <div className="call-avatar-wrapper">
                                            <div className="call-avatar" style={{
                                                background: `linear-gradient(135deg, ${currentTheme.primary}, ${currentTheme.secondary})`
                                            }}>
                                                {selectedFriend?.avatar}
                                            </div>
                                            <div className="call-avatar-pulse" style={{ borderColor: currentTheme.primary }}></div>
                                        </div>
                                        <h2>{selectedFriend?.name}</h2>
                                    </>
                                )}
                                <p>{callType === 'video' ? 'GÃ¶rÃ¼ntÃ¼lÃ¼ Arama' : 'Sesli Arama'}</p>
                            </div>

                            <div className="call-controls">
                                <button className="control-btn" title="Mikrofon">
                                    <Mic size={24} />
                                </button>
                                {callType === 'video' && (
                                    <button className="control-btn" title="Kamera">
                                        <Video size={24} />
                                    </button>
                                )}
                                <button className="control-btn end-call" onClick={endCall} title="SonlandÄ±r">
                                    <PhoneOff size={28} />
                                </button>
                            </div>
                        </div>
                    </div>
                )
            }
            {/* Confirmation Modal - Absolute Positioned within Chat Window */}
            {confirmModal.isOpen && (
                <div className="confirmation-modal-overlay absolute" onClick={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}>
                    <div className="confirmation-modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-icon">
                            {confirmModal.type === 'delete' ? <Trash2 size={32} /> : <LogOut size={32} />}
                        </div>
                        <h3>{confirmModal.title}</h3>
                        <div className="modal-message-box">
                            <p>{confirmModal.message}</p>
                        </div>
                        <div className="modal-actions">
                            <button
                                className="modal-btn cancel"
                                onClick={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                            >
                                VazgeÃ§
                            </button>
                            <button
                                className="modal-btn confirm"
                                onClick={handleConfirmAction}
                            >
                                {confirmModal.type === 'delete' ? 'Sil' : 'AyrÄ±l'}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div >
    );
};

export default ChatPage;